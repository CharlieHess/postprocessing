/**
 * @charliehess/postprocessing v6.18.0 build Mon Nov 09 2020
 * https://github.com/charliehess/postprocessing
 * Copyright 2020 Raoul van RÃ¼schen
 * @license Zlib
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("three")):"function"==typeof define&&define.amd?define(["exports","three"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self)["@CHARLIEHESS/POSTPROCESSING"]={},e.THREE)}(this,(function(e,t){"use strict";var n={RED:0,GREEN:1,BLUE:2,ALPHA:3};function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function a(e,t,n){return t&&i(e.prototype,t),n&&i(e,n),e}function s(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&l(e,t)}function o(e){return(o=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function l(e,t){return(l=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function u(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}function c(e,t,n){return(c=u()?Reflect.construct:function(e,t,n){var r=[null];r.push.apply(r,t);var i=new(Function.bind.apply(e,r));return n&&l(i,n.prototype),i}).apply(null,arguments)}function f(e){var t="function"==typeof Map?new Map:void 0;return(f=function(e){if(null===e||(n=e,-1===Function.toString.call(n).indexOf("[native code]")))return e;var n;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==t){if(t.has(e))return t.get(e);t.set(e,r)}function r(){return c(e,arguments,o(this).constructor)}return r.prototype=Object.create(e.prototype,{constructor:{value:r,enumerable:!1,writable:!0,configurable:!0}}),l(r,e)})(e)}function d(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function v(e,t){return!t||"object"!=typeof t&&"function"!=typeof t?d(e):t}function h(e){var t=u();return function(){var n,r=o(e);if(t){var i=o(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return v(this,n)}}function p(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=o(e)););return e}function g(e,t,n){return(g="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=p(e,t);if(r){var i=Object.getOwnPropertyDescriptor(r,t);return i.get?i.get.call(n):i.value}})(e,t,n||e)}function m(e,t,n,r){return(m="undefined"!=typeof Reflect&&Reflect.set?Reflect.set:function(e,t,n,r){var i,a=p(e,t);if(a){if((i=Object.getOwnPropertyDescriptor(a,t)).set)return i.set.call(r,n),!0;if(!i.writable)return!1}if(i=Object.getOwnPropertyDescriptor(r,t)){if(!i.writable)return!1;i.value=n,Object.defineProperty(r,t,i)}else!function(e,t,n){t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n}(r,t,n);return!0})(e,t,n,r)}function y(e,t,n,r,i){if(!m(e,t,n,r||e)&&i)throw new Error("failed to set property");return n}function T(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function x(e,t){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return T(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?T(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,s=!0,o=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return s=e.done,e},e:function(e){o=!0,a=e},f:function(){try{s||null==n.return||n.return()}finally{if(o)throw a}}}}var E=function(){function e(){r(this,e)}return a(e,[{key:"dispose",value:function(){}}]),e}(),S="varying vec2 vUv;void main(){vUv=position.xy*0.5+0.5;gl_Position=vec4(position.xy,1.0,1.0);}",b=function(e){s(i,e);var n=h(i);function i(){var e;return r(this,i),(e=n.call(this,{type:"AdaptiveLuminanceMaterial",defines:{MIP_LEVEL_1X1:"0.0"},uniforms:{previousLuminanceBuffer:new t.Uniform(null),currentLuminanceBuffer:new t.Uniform(null),minLuminance:new t.Uniform(.01),deltaTime:new t.Uniform(0),tau:new t.Uniform(1)},fragmentShader:"uniform sampler2D previousLuminanceBuffer;uniform sampler2D currentLuminanceBuffer;uniform float minLuminance;uniform float deltaTime;uniform float tau;varying vec2 vUv;void main(){float previousLuminance=texture2D(previousLuminanceBuffer,vUv,MIP_LEVEL_1X1).r;float currentLuminance=texture2D(currentLuminanceBuffer,vUv,MIP_LEVEL_1X1).r;previousLuminance=max(minLuminance,previousLuminance);currentLuminance=max(minLuminance,currentLuminance);float adaptedLum=previousLuminance+(currentLuminance-previousLuminance)*(1.0-exp(-deltaTime*tau));gl_FragColor.r=adaptedLum;}",vertexShader:S,depthWrite:!1,depthTest:!1})).toneMapped=!1,e}return i}(t.ShaderMaterial),D="varying vec2 vUv;varying vec2 vUv0;varying vec2 vUv1;\n#if EDGE_DETECTION_MODE != 0\nvarying vec2 vUv2;varying vec2 vUv3;varying vec2 vUv4;varying vec2 vUv5;\n#endif\n#if EDGE_DETECTION_MODE == 1\n#include <common>\n#endif\n#if EDGE_DETECTION_MODE == 0 || PREDICATION_MODE == 1\n#ifdef GL_FRAGMENT_PRECISION_HIGH\nuniform highp sampler2D depthBuffer;\n#else\nuniform mediump sampler2D depthBuffer;\n#endif\nfloat readDepth(const in vec2 uv){\n#if DEPTH_PACKING == 3201\nreturn unpackRGBAToDepth(texture2D(depthBuffer,uv));\n#else\nreturn texture2D(depthBuffer,uv).r;\n#endif\n}vec3 gatherNeighbors(){float p=readDepth(vUv);float pLeft=readDepth(vUv0);float pTop=readDepth(vUv1);return vec3(p,pLeft,pTop);}\n#elif PREDICATION_MODE == 2\nuniform sampler2D predicationBuffer;vec3 gatherNeighbors(){float p=texture2D(predicationBuffer,vUv).r;float pLeft=texture2D(predicationBuffer,vUv0).r;float pTop=texture2D(predicationBuffer,vUv1).r;return vec3(p,pLeft,pTop);}\n#endif\n#if PREDICATION_MODE != 0\nvec2 calculatePredicatedThreshold(){vec3 neighbours=gatherNeighbors();vec2 delta=abs(neighbours.xx-neighbours.yz);vec2 edges=step(PREDICATION_THRESHOLD,delta);return PREDICATION_SCALE*EDGE_THRESHOLD*(1.0-PREDICATION_STRENGTH*edges);}\n#endif\n#if EDGE_DETECTION_MODE != 0\nuniform sampler2D inputBuffer;\n#endif\nvoid main(){\n#if EDGE_DETECTION_MODE == 0\nconst vec2 threshold=vec2(DEPTH_THRESHOLD);\n#elif PREDICATION_MODE != 0\nvec2 threshold=calculatePredicatedThreshold();\n#else\nconst vec2 threshold=vec2(EDGE_THRESHOLD);\n#endif\n#if EDGE_DETECTION_MODE == 0\nvec3 neighbors=gatherNeighbors();vec2 delta=abs(neighbors.xx-vec2(neighbors.y,neighbors.z));vec2 edges=step(threshold,delta);if(dot(edges,vec2(1.0))==0.0){discard;}gl_FragColor=vec4(edges,0.0,1.0);\n#elif EDGE_DETECTION_MODE == 1\nfloat l=linearToRelativeLuminance(texture2D(inputBuffer,vUv).rgb);float lLeft=linearToRelativeLuminance(texture2D(inputBuffer,vUv0).rgb);float lTop=linearToRelativeLuminance(texture2D(inputBuffer,vUv1).rgb);vec4 delta;delta.xy=abs(l-vec2(lLeft,lTop));vec2 edges=step(threshold,delta.xy);if(dot(edges,vec2(1.0))==0.0){discard;}float lRight=linearToRelativeLuminance(texture2D(inputBuffer,vUv2).rgb);float lBottom=linearToRelativeLuminance(texture2D(inputBuffer,vUv3).rgb);delta.zw=abs(l-vec2(lRight,lBottom));vec2 maxDelta=max(delta.xy,delta.zw);float lLeftLeft=linearToRelativeLuminance(texture2D(inputBuffer,vUv4).rgb);float lTopTop=linearToRelativeLuminance(texture2D(inputBuffer,vUv5).rgb);delta.zw=abs(vec2(lLeft,lTop)-vec2(lLeftLeft,lTopTop));maxDelta=max(maxDelta.xy,delta.zw);float finalDelta=max(maxDelta.x,maxDelta.y);edges.xy*=step(finalDelta,LOCAL_CONTRAST_ADAPTATION_FACTOR*delta.xy);gl_FragColor=vec4(edges,0.0,1.0);\n#elif EDGE_DETECTION_MODE == 2\nvec4 delta;vec3 c=texture2D(inputBuffer,vUv).rgb;vec3 cLeft=texture2D(inputBuffer,vUv0).rgb;vec3 t=abs(c-cLeft);delta.x=max(max(t.r,t.g),t.b);vec3 cTop=texture2D(inputBuffer,vUv1).rgb;t=abs(c-cTop);delta.y=max(max(t.r,t.g),t.b);vec2 edges=step(threshold,delta.xy);if(dot(edges,vec2(1.0))==0.0){discard;}vec3 cRight=texture2D(inputBuffer,vUv2).rgb;t=abs(c-cRight);delta.z=max(max(t.r,t.g),t.b);vec3 cBottom=texture2D(inputBuffer,vUv3).rgb;t=abs(c-cBottom);delta.w=max(max(t.r,t.g),t.b);vec2 maxDelta=max(delta.xy,delta.zw);vec3 cLeftLeft=texture2D(inputBuffer,vUv4).rgb;t=abs(c-cLeftLeft);delta.z=max(max(t.r,t.g),t.b);vec3 cTopTop=texture2D(inputBuffer,vUv5).rgb;t=abs(c-cTopTop);delta.w=max(max(t.r,t.g),t.b);maxDelta=max(maxDelta.xy,delta.zw);float finalDelta=max(maxDelta.x,maxDelta.y);edges*=step(finalDelta,LOCAL_CONTRAST_ADAPTATION_FACTOR*delta.xy);gl_FragColor=vec4(edges,0.0,1.0);\n#endif\n}",M="uniform vec2 texelSize;varying vec2 vUv;varying vec2 vUv0;varying vec2 vUv1;\n#if EDGE_DETECTION_MODE != 0\nvarying vec2 vUv2;varying vec2 vUv3;varying vec2 vUv4;varying vec2 vUv5;\n#endif\nvoid main(){vUv=position.xy*0.5+0.5;vUv0=vUv+texelSize*vec2(-1.0,0.0);vUv1=vUv+texelSize*vec2(0.0,-1.0);\n#if EDGE_DETECTION_MODE != 0\nvUv2=vUv+texelSize*vec2(1.0,0.0);vUv3=vUv+texelSize*vec2(0.0,1.0);vUv4=vUv+texelSize*vec2(-2.0,0.0);vUv5=vUv+texelSize*vec2(0.0,-2.0);\n#endif\ngl_Position=vec4(position.xy,1.0,1.0);}",k=function(e){s(i,e);var n=h(i);function i(){var e,a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new t.Vector2;return r(this,i),(e=n.call(this,{type:"ColorEdgesMaterial",defines:{EDGE_DETECTION_MODE:"2",LOCAL_CONTRAST_ADAPTATION_FACTOR:"2.0",EDGE_THRESHOLD:"0.1"},uniforms:{inputBuffer:new t.Uniform(null),texelSize:new t.Uniform(a)},fragmentShader:D,vertexShader:M,depthWrite:!1,depthTest:!1})).toneMapped=!1,e}return a(i,[{key:"setLocalContrastAdaptationFactor",value:function(e){this.defines.LOCAL_CONTRAST_ADAPTATION_FACTOR=e.toFixed("2"),this.needsUpdate=!0}},{key:"setEdgeDetectionThreshold",value:function(e){var t=Math.min(Math.max(e,.05),.5);this.defines.EDGE_THRESHOLD=t.toFixed("2"),this.needsUpdate=!0}}]),i}(t.ShaderMaterial),A="#include <common>\n#include <dithering_pars_fragment>\nuniform sampler2D inputBuffer;varying vec2 vUv0;varying vec2 vUv1;varying vec2 vUv2;varying vec2 vUv3;void main(){vec4 sum=texture2D(inputBuffer,vUv0);sum+=texture2D(inputBuffer,vUv1);sum+=texture2D(inputBuffer,vUv2);sum+=texture2D(inputBuffer,vUv3);gl_FragColor=sum*0.25;\n#include <dithering_fragment>\n}",U="uniform vec2 texelSize;uniform vec2 halfTexelSize;uniform float kernel;uniform float scale;/*Packing multiple texture coordinates into one varying and using a swizzle toextract them in the fragment shader still causes a dependent texture read.*/varying vec2 vUv0;varying vec2 vUv1;varying vec2 vUv2;varying vec2 vUv3;void main(){vec2 uv=position.xy*0.5+0.5;vec2 dUv=(texelSize*vec2(kernel)+halfTexelSize)*scale;vUv0=vec2(uv.x-dUv.x,uv.y+dUv.y);vUv1=vec2(uv.x+dUv.x,uv.y+dUv.y);vUv2=vec2(uv.x+dUv.x,uv.y-dUv.y);vUv3=vec2(uv.x-dUv.x,uv.y-dUv.y);gl_Position=vec4(position.xy,1.0,1.0);}",P=function(e){s(i,e);var n=h(i);function i(){var e,a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new t.Vector2;return r(this,i),(e=n.call(this,{type:"ConvolutionMaterial",uniforms:{inputBuffer:new t.Uniform(null),texelSize:new t.Uniform(new t.Vector2),halfTexelSize:new t.Uniform(new t.Vector2),kernel:new t.Uniform(0),scale:new t.Uniform(1)},fragmentShader:A,vertexShader:U,depthWrite:!1,depthTest:!1})).toneMapped=!1,e.setTexelSize(a.x,a.y),e.kernelSize=R.LARGE,e}return a(i,[{key:"getKernel",value:function(){return w[this.kernelSize]}},{key:"setTexelSize",value:function(e,t){this.uniforms.texelSize.value.set(e,t),this.uniforms.halfTexelSize.value.set(e,t).multiplyScalar(.5)}}]),i}(t.ShaderMaterial),w=[new Float32Array([0,0]),new Float32Array([0,1,1]),new Float32Array([0,1,1,2]),new Float32Array([0,1,2,2,3]),new Float32Array([0,1,2,3,4,4,5]),new Float32Array([0,1,2,3,4,5,7,8,9,10])],R={VERY_SMALL:0,SMALL:1,MEDIUM:2,LARGE:3,VERY_LARGE:4,HUGE:5},C=function(e){s(i,e);var n=h(i);function i(){var e;return r(this,i),(e=n.call(this,{type:"CopyMaterial",uniforms:{inputBuffer:new t.Uniform(null),opacity:new t.Uniform(1)},fragmentShader:"uniform sampler2D inputBuffer;uniform float opacity;varying vec2 vUv;void main(){vec4 texel=texture2D(inputBuffer,vUv);gl_FragColor=opacity*texel;\n#include <encodings_fragment>\n}",vertexShader:S,depthWrite:!1,depthTest:!1})).toneMapped=!1,e}return i}(t.ShaderMaterial),_="#include <packing>\n#include <clipping_planes_pars_fragment>\n#ifdef GL_FRAGMENT_PRECISION_HIGH\nuniform highp sampler2D depthBuffer;\n#else\nuniform mediump sampler2D depthBuffer;\n#endif\nuniform float cameraNear;uniform float cameraFar;varying float vViewZ;varying vec4 vProjTexCoord;void main(){\n#include <clipping_planes_fragment>\nvec2 projTexCoord=(vProjTexCoord.xy/vProjTexCoord.w)*0.5+0.5;projTexCoord=clamp(projTexCoord,0.002,0.998);float fragCoordZ=unpackRGBAToDepth(texture2D(depthBuffer,projTexCoord));\n#ifdef PERSPECTIVE_CAMERA\nfloat viewZ=perspectiveDepthToViewZ(fragCoordZ,cameraNear,cameraFar);\n#else\nfloat viewZ=orthographicDepthToViewZ(fragCoordZ,cameraNear,cameraFar);\n#endif\nfloat depthTest=(-vViewZ>-viewZ)? 1.0 : 0.0;gl_FragColor.rg=vec2(0.0,depthTest);}",O="#include <common>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvarying float vViewZ;varying vec4 vProjTexCoord;void main(){\n#include <skinbase_vertex>\n#include <begin_vertex>\n#include <morphtarget_vertex>\n#include <skinning_vertex>\n#include <project_vertex>\nvViewZ=mvPosition.z;vProjTexCoord=gl_Position;\n#include <clipping_planes_vertex>\n}",N=function(e){s(i,e);var n=h(i);function i(){var e,a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,s=arguments.length>1?arguments[1]:void 0;return r(this,i),(e=n.call(this,{type:"DepthComparisonMaterial",uniforms:{depthBuffer:new t.Uniform(a),cameraNear:new t.Uniform(.3),cameraFar:new t.Uniform(1e3)},fragmentShader:_,vertexShader:O,depthWrite:!1,depthTest:!1,morphTargets:!0,skinning:!0})).toneMapped=!1,e.adoptCameraSettings(s),e}return a(i,[{key:"adoptCameraSettings",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;null!==e&&(this.uniforms.cameraNear.value=e.near,this.uniforms.cameraFar.value=e.far,e instanceof t.PerspectiveCamera?this.defines.PERSPECTIVE_CAMERA="1":delete this.defines.PERSPECTIVE_CAMERA)}}]),i}(t.ShaderMaterial),B=function(e){s(i,e);var n=h(i);function i(){var e;return r(this,i),(e=n.call(this,{type:"DepthDownsamplingMaterial",defines:{DEPTH_PACKING:"0"},uniforms:{depthBuffer:new t.Uniform(null),normalBuffer:new t.Uniform(null),texelSize:new t.Uniform(new t.Vector2)},fragmentShader:"#include <packing>\n#ifdef GL_FRAGMENT_PRECISION_HIGH\nuniform highp sampler2D depthBuffer;\n#else\nuniform mediump sampler2D depthBuffer;\n#endif\n#ifdef DOWNSAMPLE_NORMALS\nuniform sampler2D normalBuffer;\n#endif\nvarying vec2 vUv0;varying vec2 vUv1;varying vec2 vUv2;varying vec2 vUv3;float readDepth(const in vec2 uv){\n#if DEPTH_PACKING == 3201\nreturn unpackRGBAToDepth(texture2D(depthBuffer,uv));\n#else\nreturn texture2D(depthBuffer,uv).r;\n#endif\n}/***Returns the index of the most representative depth in the 2x2 neighborhood.*/int findBestDepth(const in float samples[4]){float c=(samples[0]+samples[1]+samples[2]+samples[3])/4.0;float distances[4]=float[](abs(c-samples[0]),abs(c-samples[1]),abs(c-samples[2]),abs(c-samples[3]));float maxDistance=max(max(distances[0],distances[1]),max(distances[2],distances[3]));int remaining[3];int rejected[3];int i,j,k;for(i=0,j=0,k=0;i<4;++i){if(distances[i]<maxDistance){remaining[j++]=i;}else{rejected[k++]=i;}}for(;j<3;++j){remaining[j]=rejected[--k];}vec3 s=vec3(samples[remaining[0]],samples[remaining[1]],samples[remaining[2]]);c=(s.x+s.y+s.z)/3.0;distances[0]=abs(c-s.x);distances[1]=abs(c-s.y);distances[2]=abs(c-s.z);float minDistance=min(distances[0],min(distances[1],distances[2]));for(i=0;i<3;++i){if(distances[i]==minDistance){break;}}return remaining[i];}void main(){float d[4]=float[](readDepth(vUv0),readDepth(vUv1),readDepth(vUv2),readDepth(vUv3));int index=findBestDepth(d);\n#ifdef DOWNSAMPLE_NORMALS\nvec2 uvs[4]=vec2[](vUv0,vUv1,vUv2,vUv3);vec3 n=texture2D(normalBuffer,uvs[index]).rgb;\n#else\nvec3 n=vec3(0.0);\n#endif\ngl_FragColor=vec4(n,d[index]);}",vertexShader:"uniform vec2 texelSize;varying vec2 vUv0;varying vec2 vUv1;varying vec2 vUv2;varying vec2 vUv3;void main(){vec2 uv=position.xy*0.5+0.5;vUv0=uv;vUv1=vec2(uv.x,uv.y+texelSize.y);vUv2=vec2(uv.x+texelSize.x,uv.y);vUv3=uv+texelSize;gl_Position=vec4(position.xy,1.0,1.0);}",depthWrite:!1,depthTest:!1})).toneMapped=!1,e}return a(i,[{key:"setTexelSize",value:function(e,t){this.uniforms.texelSize.value.set(e,t)}},{key:"depthPacking",get:function(){return Number(this.defines.DEPTH_PACKING)},set:function(e){this.defines.DEPTH_PACKING=e.toFixed(0),this.needsUpdate=!0}}]),i}(t.ShaderMaterial),F=function(e){s(i,e);var n=h(i);function i(){var e;return r(this,i),(e=n.call(this,{type:"DepthMaskMaterial",defines:{DEPTH_PACKING_0:"0",DEPTH_PACKING_1:"0"},uniforms:{depthBuffer0:new t.Uniform(null),depthBuffer1:new t.Uniform(null),inputBuffer:new t.Uniform(null)},fragmentShader:"#include <common>\n#include <packing>\n#ifdef GL_FRAGMENT_PRECISION_HIGH\nuniform highp sampler2D depthBuffer0;uniform highp sampler2D depthBuffer1;\n#else\nuniform mediump sampler2D depthBuffer0;uniform mediump sampler2D depthBuffer1;\n#endif\nuniform sampler2D inputBuffer;varying vec2 vUv;void main(){\n#if DEPTH_PACKING_0 == 3201\nfloat d0=unpackRGBAToDepth(texture2D(depthBuffer0,vUv));\n#else\nfloat d0=texture2D(depthBuffer0,vUv).r;\n#endif\n#if DEPTH_PACKING_1 == 3201\nfloat d1=unpackRGBAToDepth(texture2D(depthBuffer1,vUv));\n#else\nfloat d1=texture2D(depthBuffer1,vUv).r;\n#endif\nif(d0<d1){discard;}gl_FragColor=texture2D(inputBuffer,vUv);}",vertexShader:S,depthWrite:!1,depthTest:!1})).toneMapped=!1,e}return i}(t.ShaderMaterial),L=function(e){s(i,e);var n=h(i);function i(){var e,a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new t.Vector2,s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:I.COLOR;return r(this,i),(e=n.call(this,{type:"EdgeDetectionMaterial",defines:{LOCAL_CONTRAST_ADAPTATION_FACTOR:"2.0",EDGE_THRESHOLD:"0.1",DEPTH_THRESHOLD:"0.01",PREDICATION_MODE:"0",PREDICATION_THRESHOLD:"0.01",PREDICATION_SCALE:"2.0",PREDICATION_STRENGTH:"1.0",DEPTH_PACKING:"0"},uniforms:{inputBuffer:new t.Uniform(null),depthBuffer:new t.Uniform(null),predicationBuffer:new t.Uniform(null),texelSize:new t.Uniform(a)},fragmentShader:D,vertexShader:M,depthWrite:!1,depthTest:!1})).toneMapped=!1,e.setEdgeDetectionMode(s),e}return a(i,[{key:"setEdgeDetectionMode",value:function(e){this.defines.EDGE_DETECTION_MODE=e.toFixed(0),this.needsUpdate=!0}},{key:"setLocalContrastAdaptationFactor",value:function(e){this.defines.LOCAL_CONTRAST_ADAPTATION_FACTOR=e.toFixed("6"),this.needsUpdate=!0}},{key:"setEdgeDetectionThreshold",value:function(e){this.defines.EDGE_THRESHOLD=e.toFixed("6"),this.defines.DEPTH_THRESHOLD=(.1*e).toFixed("6"),this.needsUpdate=!0}},{key:"setPredicationMode",value:function(e){this.defines.PREDICATION_MODE=e.toFixed(0),this.needsUpdate=!0}},{key:"setPredicationBuffer",value:function(e){this.uniforms.predicationBuffer.value=e}},{key:"setPredicationThreshold",value:function(e){this.defines.PREDICATION_THRESHOLD=e.toFixed("6"),this.needsUpdate=!0}},{key:"setPredicationScale",value:function(e){this.defines.PREDICATION_SCALE=e.toFixed("6"),this.needsUpdate=!0}},{key:"setPredicationStrength",value:function(e){this.defines.PREDICATION_STRENGTH=e.toFixed("6"),this.needsUpdate=!0}},{key:"depthPacking",get:function(){return Number(this.defines.DEPTH_PACKING)},set:function(e){this.defines.DEPTH_PACKING=e.toFixed(0),this.needsUpdate=!0}}]),i}(t.ShaderMaterial),I={DEPTH:0,LUMA:1,COLOR:2},z=function(e){s(i,e);var n=h(i);function i(){var e,a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,l=arguments.length>3?arguments[3]:void 0,u=arguments.length>4&&void 0!==arguments[4]&&arguments[4];return r(this,i),(e=n.call(this,{type:"EffectMaterial",defines:{DEPTH_PACKING:"0",ENCODE_OUTPUT:"1"},uniforms:{inputBuffer:new t.Uniform(null),depthBuffer:new t.Uniform(null),resolution:new t.Uniform(new t.Vector2),texelSize:new t.Uniform(new t.Vector2),cameraNear:new t.Uniform(.3),cameraFar:new t.Uniform(1e3),aspect:new t.Uniform(1),time:new t.Uniform(0)},depthWrite:!1,depthTest:!1,dithering:u})).toneMapped=!1,null!==a&&e.setShaderParts(a),null!==s&&e.setDefines(s),null!==o&&e.setUniforms(o),e.adoptCameraSettings(l),e}return a(i,[{key:"setShaderParts",value:function(e){return this.fragmentShader="#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\nuniform sampler2D inputBuffer;\n#ifdef GL_FRAGMENT_PRECISION_HIGH\nuniform highp sampler2D depthBuffer;\n#else\nuniform mediump sampler2D depthBuffer;\n#endif\nuniform vec2 resolution;uniform vec2 texelSize;uniform float cameraNear;uniform float cameraFar;uniform float aspect;uniform float time;varying vec2 vUv;float readDepth(const in vec2 uv){\n#if DEPTH_PACKING == 3201\nreturn unpackRGBAToDepth(texture2D(depthBuffer,uv));\n#else\nreturn texture2D(depthBuffer,uv).r;\n#endif\n}float getViewZ(const in float depth){\n#ifdef PERSPECTIVE_CAMERA\nreturn perspectiveDepthToViewZ(depth,cameraNear,cameraFar);\n#else\nreturn orthographicDepthToViewZ(depth,cameraNear,cameraFar);\n#endif\n}FRAGMENT_HEADvoid main(){FRAGMENT_MAIN_UVvec4 color0=texture2D(inputBuffer,UV);vec4 color1=vec4(0.0);FRAGMENT_MAIN_IMAGEgl_FragColor=color0;\n#ifdef ENCODE_OUTPUT\n#include <encodings_fragment>\n#endif\n#include <dithering_fragment>\n}".replace(G.FRAGMENT_HEAD,e.get(G.FRAGMENT_HEAD)).replace(G.FRAGMENT_MAIN_UV,e.get(G.FRAGMENT_MAIN_UV)).replace(G.FRAGMENT_MAIN_IMAGE,e.get(G.FRAGMENT_MAIN_IMAGE)),this.vertexShader="uniform vec2 resolution;uniform vec2 texelSize;uniform float cameraNear;uniform float cameraFar;uniform float aspect;uniform float time;varying vec2 vUv;VERTEX_HEADvoid main(){vUv=position.xy*0.5+0.5;VERTEX_MAIN_SUPPORTgl_Position=vec4(position.xy,1.0,1.0);}".replace(G.VERTEX_HEAD,e.get(G.VERTEX_HEAD)).replace(G.VERTEX_MAIN_SUPPORT,e.get(G.VERTEX_MAIN_SUPPORT)),this.needsUpdate=!0,this}},{key:"setDefines",value:function(e){var t,n=x(e.entries());try{for(n.s();!(t=n.n()).done;){var r=t.value;this.defines[r[0]]=r[1]}}catch(e){n.e(e)}finally{n.f()}return this.needsUpdate=!0,this}},{key:"setUniforms",value:function(e){var t,n=x(e.entries());try{for(n.s();!(t=n.n()).done;){var r=t.value;this.uniforms[r[0]]=r[1]}}catch(e){n.e(e)}finally{n.f()}return this}},{key:"adoptCameraSettings",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;null!==e&&(this.uniforms.cameraNear.value=e.near,this.uniforms.cameraFar.value=e.far,e instanceof t.PerspectiveCamera?this.defines.PERSPECTIVE_CAMERA="1":delete this.defines.PERSPECTIVE_CAMERA,this.needsUpdate=!0)}},{key:"setSize",value:function(e,t){var n=Math.max(e,1),r=Math.max(t,1);this.uniforms.resolution.value.set(n,r),this.uniforms.texelSize.value.set(1/n,1/r),this.uniforms.aspect.value=n/r}},{key:"depthPacking",get:function(){return Number(this.defines.DEPTH_PACKING)},set:function(e){this.defines.DEPTH_PACKING=e.toFixed(0),this.needsUpdate=!0}}]),i}(t.ShaderMaterial),G={FRAGMENT_HEAD:"FRAGMENT_HEAD",FRAGMENT_MAIN_UV:"FRAGMENT_MAIN_UV",FRAGMENT_MAIN_IMAGE:"FRAGMENT_MAIN_IMAGE",VERTEX_HEAD:"VERTEX_HEAD",VERTEX_MAIN_SUPPORT:"VERTEX_MAIN_SUPPORT"},V="#include <common>\nuniform sampler2D inputBuffer;\n#ifdef RANGE\nuniform vec2 range;\n#elif defined(THRESHOLD)\nuniform float threshold;uniform float smoothing;\n#endif\nvarying vec2 vUv;void main(){vec4 texel=texture2D(inputBuffer,vUv);float l=linearToRelativeLuminance(texel.rgb);\n#ifdef RANGE\nfloat low=step(range.x,l);float high=step(l,range.y);l*=low*high;\n#elif defined(THRESHOLD)\nl=smoothstep(threshold,threshold+smoothing,l);\n#endif\n#ifdef COLOR\ngl_FragColor=vec4(texel.rgb*l,l);\n#else\ngl_FragColor=vec4(l);\n#endif\n}",H=function(e){s(i,e);var n=h(i);function i(){var e,a=arguments.length>0&&void 0!==arguments[0]&&arguments[0],s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;r(this,i);var o=null!==s;return(e=n.call(this,{type:"LuminanceMaterial",uniforms:{inputBuffer:new t.Uniform(null),threshold:new t.Uniform(0),smoothing:new t.Uniform(1),range:new t.Uniform(o?s:new t.Vector2)},fragmentShader:V,vertexShader:S,depthWrite:!1,depthTest:!1})).toneMapped=!1,e.colorOutput=a,e.useThreshold=!0,e.useRange=o,e}return a(i,[{key:"setColorOutputEnabled",value:function(e){this.colorOutput=e}},{key:"setLuminanceRangeEnabled",value:function(e){this.useRange=e}},{key:"threshold",get:function(){return this.uniforms.threshold.value},set:function(e){this.uniforms.threshold.value=e}},{key:"smoothing",get:function(){return this.uniforms.smoothing.value},set:function(e){this.uniforms.smoothing.value=e}},{key:"useThreshold",get:function(){return void 0!==this.defines.THRESHOLD},set:function(e){e?this.defines.THRESHOLD="1":delete this.defines.THRESHOLD,this.needsUpdate=!0}},{key:"colorOutput",get:function(){return void 0!==this.defines.COLOR},set:function(e){e?this.defines.COLOR="1":delete this.defines.COLOR,this.needsUpdate=!0}},{key:"useRange",get:function(){return void 0!==this.defines.RANGE},set:function(e){e?this.defines.RANGE="1":delete this.defines.RANGE,this.needsUpdate=!0}},{key:"luminanceRange",get:function(){return this.useRange},set:function(e){this.useRange=e}}]),i}(t.ShaderMaterial),j="uniform sampler2D maskTexture;uniform sampler2D inputBuffer;\n#if MASK_FUNCTION != 0\nuniform float strength;\n#endif\nvarying vec2 vUv;void main(){\n#if COLOR_CHANNEL == 0\nfloat mask=texture2D(maskTexture,vUv).r;\n#elif COLOR_CHANNEL == 1\nfloat mask=texture2D(maskTexture,vUv).g;\n#elif COLOR_CHANNEL == 2\nfloat mask=texture2D(maskTexture,vUv).b;\n#else\nfloat mask=texture2D(maskTexture,vUv).a;\n#endif\n#if MASK_FUNCTION == 0\n#ifdef INVERTED\nif(mask>0.0){discard;}\n#else\nif(mask==0.0){discard;}\n#endif\n#else\nmask=clamp(mask*strength,0.0,1.0);\n#ifdef INVERTED\nmask=(1.0-mask);\n#endif\n#if MASK_FUNCTION == 1\ngl_FragColor=mask*texture2D(inputBuffer,vUv);\n#else\ngl_FragColor=vec4(mask*texture2D(inputBuffer,vUv).rgb,mask);\n#endif\n#endif\n}",W=function(e){s(o,e);var i=h(o);function o(){var e,a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;return r(this,o),(e=i.call(this,{type:"MaskMaterial",uniforms:{maskTexture:new t.Uniform(a),inputBuffer:new t.Uniform(null),strength:new t.Uniform(1)},fragmentShader:j,vertexShader:S,depthWrite:!1,depthTest:!1})).toneMapped=!1,e.colorChannel=n.RED,e.maskFunction=K.DISCARD,e}return a(o,[{key:"maskTexture",set:function(e){this.uniforms.maskTexture.value=e}},{key:"colorChannel",set:function(e){this.defines.COLOR_CHANNEL=e.toFixed(0),this.needsUpdate=!0}},{key:"maskFunction",set:function(e){this.defines.MASK_FUNCTION=e.toFixed(0),this.needsUpdate=!0}},{key:"inverted",get:function(){return void 0!==this.defines.INVERTED},set:function(e){this.inverted&&!e?delete this.defines.INVERTED:e&&(this.defines.INVERTED="1"),this.needsUpdate=!0}},{key:"strength",get:function(){return this.uniforms.strength.value},set:function(e){this.uniforms.strength.value=e}}]),o}(t.ShaderMaterial),K={DISCARD:0,MULTIPLY:1,MULTIPLY_RGB_SET_ALPHA:2},Z="uniform sampler2D inputBuffer;varying vec2 vUv0;varying vec2 vUv1;varying vec2 vUv2;varying vec2 vUv3;void main(){vec2 c0=texture2D(inputBuffer,vUv0).rg;vec2 c1=texture2D(inputBuffer,vUv1).rg;vec2 c2=texture2D(inputBuffer,vUv2).rg;vec2 c3=texture2D(inputBuffer,vUv3).rg;float d0=(c0.x-c1.x)*0.5;float d1=(c2.x-c3.x)*0.5;float d=length(vec2(d0,d1));float a0=min(c0.y,c1.y);float a1=min(c2.y,c3.y);float visibilityFactor=min(a0,a1);gl_FragColor.rg=(1.0-visibilityFactor>0.001)? vec2(d,0.0): vec2(0.0,d);}",X="uniform vec2 texelSize;varying vec2 vUv0;varying vec2 vUv1;varying vec2 vUv2;varying vec2 vUv3;void main(){vec2 uv=position.xy*0.5+0.5;vUv0=vec2(uv.x+texelSize.x,uv.y);vUv1=vec2(uv.x-texelSize.x,uv.y);vUv2=vec2(uv.x,uv.y+texelSize.y);vUv3=vec2(uv.x,uv.y-texelSize.y);gl_Position=vec4(position.xy,1.0,1.0);}",Y=function(e){s(i,e);var n=h(i);function i(){var e,a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new t.Vector2;return r(this,i),(e=n.call(this,{type:"OutlineMaterial",uniforms:{inputBuffer:new t.Uniform(null),texelSize:new t.Uniform(new t.Vector2)},fragmentShader:Z,vertexShader:X,depthWrite:!1,depthTest:!1})).toneMapped=!1,e.setTexelSize(a.x,a.y),e.uniforms.maskTexture=e.uniforms.inputBuffer,e}return a(i,[{key:"setTexelSize",value:function(e,t){this.uniforms.texelSize.value.set(e,t)}}]),i}(t.ShaderMaterial),q=Y,Q=-1,$=function(){function e(n){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Q,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Q,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;r(this,e),this.resizable=n,this.base=new t.Vector2(1,1),this.target=new t.Vector2(i,a),this.s=s}return a(e,[{key:"scale",get:function(){return this.s},set:function(e){this.s=e,this.target.x=Q,this.target.y=Q,this.resizable.setSize(this.base.x,this.base.y)}},{key:"width",get:function(){var e=this.base,t=this.target;return t.x!==Q?t.x:t.y!==Q?Math.round(t.y*(e.x/e.y)):Math.round(e.x*this.s)},set:function(e){this.target.x=e,this.resizable.setSize(this.base.x,this.base.y)}},{key:"height",get:function(){var e=this.base,t=this.target;return t.y!==Q?t.y:t.x!==Q?Math.round(t.x/(e.x/e.y)):Math.round(e.y*this.s)},set:function(e){this.target.y=e,this.resizable.setSize(this.base.x,this.base.y)}}],[{key:"AUTO_SIZE",get:function(){return Q}}]),e}(),J=new t.Camera,ee=null;var te=function(){function e(){var n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"Pass",i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new t.Scene,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:J;r(this,e),this.name=n,this.scene=i,this.camera=a,this.screen=null,this.rtt=!0,this.needsSwap=!0,this.needsDepthTexture=!1,this.enabled=!0}return a(e,[{key:"getFullscreenMaterial",value:function(){return null!==this.screen?this.screen.material:null}},{key:"setFullscreenMaterial",value:function(e){var n=this.screen;null!==n?n.material=e:((n=new t.Mesh(function(){if(null===ee){var e=new Float32Array([-1,-1,0,3,-1,0,-1,3,0]),n=new Float32Array([0,0,2,0,0,2]);void 0!==(ee=new t.BufferGeometry).setAttribute?(ee.setAttribute("position",new t.BufferAttribute(e,3)),ee.setAttribute("uv",new t.BufferAttribute(n,2))):(ee.addAttribute("position",new t.BufferAttribute(e,3)),ee.addAttribute("uv",new t.BufferAttribute(n,2)))}return ee}(),e)).frustumCulled=!1,null===this.scene&&(this.scene=new t.Scene),this.scene.add(n),this.screen=n)}},{key:"getDepthTexture",value:function(){return null}},{key:"setDepthTexture",value:function(e){}},{key:"render",value:function(e,t,n,r,i){throw new Error("Render method not implemented!")}},{key:"setSize",value:function(e,t){}},{key:"initialize",value:function(e,t,n){}},{key:"dispose",value:function(){var e=this.getFullscreenMaterial();null!==e&&e.dispose();for(var n=0,r=Object.keys(this);n<r.length;n++){var i=r[n],a=this[i];if(null!==a&&"function"==typeof a.dispose){if(a instanceof t.Scene)continue;this[i].dispose()}}}},{key:"renderToScreen",get:function(){return!this.rtt},set:function(e){if(this.rtt===e){var t=this.getFullscreenMaterial();null!==t&&(t.needsUpdate=!0),this.rtt=!e}}}]),e}(),ne=function(e){s(i,e);var n=h(i);function i(){var e,a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},s=a.resolutionScale,o=void 0===s?.5:s,l=a.width,u=void 0===l?$.AUTO_SIZE:l,c=a.height,f=void 0===c?$.AUTO_SIZE:c,v=a.kernelSize,h=void 0===v?R.LARGE:v;return r(this,i),(e=n.call(this,"BlurPass")).renderTargetA=new t.WebGLRenderTarget(1,1,{minFilter:t.LinearFilter,magFilter:t.LinearFilter,stencilBuffer:!1,depthBuffer:!1}),e.renderTargetA.texture.name="Blur.Target.A",e.renderTargetB=e.renderTargetA.clone(),e.renderTargetB.texture.name="Blur.Target.B",e.resolution=new $(d(e),u,f,o),e.convolutionMaterial=new P,e.ditheredConvolutionMaterial=new P,e.ditheredConvolutionMaterial.dithering=!0,e.dithering=!1,e.kernelSize=h,e}return a(i,[{key:"getResolutionScale",value:function(){return this.resolution.scale}},{key:"setResolutionScale",value:function(e){this.resolution.scale=e}},{key:"render",value:function(e,t,n,r,i){var a,s,o,l=this.scene,u=this.camera,c=this.renderTargetA,f=this.renderTargetB,d=this.convolutionMaterial,v=d.uniforms,h=d.getKernel(),p=t;for(this.setFullscreenMaterial(d),s=0,o=h.length-1;s<o;++s)a=0==(1&s)?c:f,v.kernel.value=h[s],v.inputBuffer.value=p.texture,e.setRenderTarget(a),e.render(l,u),p=a;this.dithering&&(v=(d=this.ditheredConvolutionMaterial).uniforms,this.setFullscreenMaterial(d)),v.kernel.value=h[s],v.inputBuffer.value=p.texture,e.setRenderTarget(this.renderToScreen?null:n),e.render(l,u)}},{key:"setSize",value:function(e,t){var n=this.resolution;n.base.set(e,t);var r=n.width,i=n.height;this.renderTargetA.setSize(r,i),this.renderTargetB.setSize(r,i),this.convolutionMaterial.setTexelSize(1/r,1/i),this.ditheredConvolutionMaterial.setTexelSize(1/r,1/i)}},{key:"initialize",value:function(e,n,r){n||r!==t.UnsignedByteType||(this.renderTargetA.texture.format=t.RGBFormat,this.renderTargetB.texture.format=t.RGBFormat),void 0!==r&&(this.renderTargetA.texture.type=r,this.renderTargetB.texture.type=r)}},{key:"width",get:function(){return this.resolution.width},set:function(e){this.resolution.width=e}},{key:"height",get:function(){return this.resolution.height},set:function(e){this.resolution.height=e}},{key:"scale",get:function(){return this.convolutionMaterial.uniforms.scale.value},set:function(e){this.convolutionMaterial.uniforms.scale.value=e,this.ditheredConvolutionMaterial.uniforms.scale.value=e}},{key:"kernelSize",get:function(){return this.convolutionMaterial.kernelSize},set:function(e){this.convolutionMaterial.kernelSize=e,this.ditheredConvolutionMaterial.kernelSize=e}}],[{key:"AUTO_SIZE",get:function(){return $.AUTO_SIZE}}]),i}(te),re=function(e){s(n,e);var t=h(n);function n(){var e;return r(this,n),(e=t.call(this,"ClearMaskPass",null,null)).needsSwap=!1,e}return a(n,[{key:"render",value:function(e,t,n,r,i){var a=e.state.buffers.stencil;a.setLocked(!1),a.setTest(!1)}}]),n}(te),ie=new t.Color,ae=function(e){s(n,e);var t=h(n);function n(){var e,i=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],a=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],s=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return r(this,n),(e=t.call(this,"ClearPass",null,null)).needsSwap=!1,e.color=i,e.depth=a,e.stencil=s,e.overrideClearColor=null,e.overrideClearAlpha=-1,e}return a(n,[{key:"render",value:function(e,t,n,r,i){var a=this.overrideClearColor,s=this.overrideClearAlpha,o=e.getClearAlpha(),l=null!==a,u=s>=0;l?(ie.copy(e.getClearColor()),e.setClearColor(a,u?s:o)):u&&e.setClearAlpha(s),e.setRenderTarget(this.renderToScreen?null:t),e.clear(this.color,this.depth,this.stencil),l?e.setClearColor(ie,o):u&&e.setClearAlpha(o)}}]),n}(te),se=!1,oe=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;r(this,e),this.originalMaterials=new Map,this.material=null,this.materialInstanced=null,this.materialSkinning=null,this.setMaterial(t)}return a(e,[{key:"setMaterial",value:function(e){this.disposeMaterials(),null!==e&&(this.material=e,this.materialInstanced=e.clone(),this.materialInstanced.uniforms=Object.assign({},e.uniforms),this.materialSkinning=e.clone(),this.materialSkinning.uniforms=Object.assign({},e.uniforms),this.materialSkinning.skinning=!0)}},{key:"render",value:function(e,t,n){var r=this.material,i=this.materialSkinning,a=this.materialInstanced,s=this.originalMaterials,o=e.shadowMap.enabled;if(e.shadowMap.enabled=!1,se){var l=0;t.traverse((function(e){e.isMesh&&(s.set(e,e.material),e.isInstancedMesh?e.material=a:e.isSkinnedMesh?e.material=i:e.material=r,++l)})),e.render(t,n);var u,c=x(s);try{for(c.s();!(u=c.n()).done;){var f=u.value;f[0].material=f[1]}}catch(e){c.e(e)}finally{c.f()}l!==s.size&&s.clear()}else{var d=t.overrideMaterial;t.overrideMaterial=r,e.render(t,n),t.overrideMaterial=d}e.shadowMap.enabled=o}},{key:"disposeMaterials",value:function(){null!==this.materialInstanced&&this.materialInstanced.dispose(),null!==this.materialSkinning&&this.materialSkinning.dispose()}},{key:"dispose",value:function(){this.originalMaterials.clear(),this.disposeMaterials()}}],[{key:"workaroundEnabled",get:function(){return se},set:function(e){se=e}}]),e}(),le=function(e){s(n,e);var t=h(n);function n(e,i){var a,s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;return r(this,n),(a=t.call(this,"RenderPass",e,i)).needsSwap=!1,a.clearPass=new ae,a.overrideMaterialManager=null===s?null:new oe(s),a}return a(n,[{key:"getClearPass",value:function(){return this.clearPass}},{key:"render",value:function(e,t,n,r,i){var a=this.scene,s=this.camera,o=a.background,l=this.renderToScreen?null:t;this.clear&&(null!==this.clearPass.overrideClearColor&&(a.background=null),this.clearPass.render(e,t)),e.setRenderTarget(l),null!==this.overrideMaterialManager?this.overrideMaterialManager.render(e,a,s):e.render(a,s),a.background!==o&&(a.background=o)}},{key:"renderToScreen",get:function(){return g(o(n.prototype),"renderToScreen",this)},set:function(e){y(o(n.prototype),"renderToScreen",e,this,!0),this.clearPass.renderToScreen=e}},{key:"overrideMaterial",get:function(){var e=this.overrideMaterialManager;return null!==e?e.material:null},set:function(e){var t=this.overrideMaterialManager;null!==e?null!==t?t.setMaterial(e):this.overrideMaterialManager=new oe(e):null!==t&&(t.dispose(),this.overrideMaterialManager=null)}},{key:"clear",get:function(){return this.clearPass.enabled},set:function(e){this.clearPass.enabled=e}}]),n}(te),ue=function(e){s(i,e);var n=h(i);function i(e,a){var s,o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},l=o.resolutionScale,u=void 0===l?1:l,c=o.width,f=void 0===c?$.AUTO_SIZE:c,v=o.height,h=void 0===v?$.AUTO_SIZE:v,p=o.renderTarget;r(this,i),(s=n.call(this,"DepthPass")).needsSwap=!1,s.renderPass=new le(e,a,new t.MeshDepthMaterial({depthPacking:t.RGBADepthPacking}));var g=s.renderPass.getClearPass();return g.overrideClearColor=new t.Color(16777215),g.overrideClearAlpha=1,s.renderTarget=p,void 0===s.renderTarget&&(s.renderTarget=new t.WebGLRenderTarget(1,1,{minFilter:t.NearestFilter,magFilter:t.NearestFilter,stencilBuffer:!1}),s.renderTarget.texture.name="DepthPass.Target"),s.resolution=new $(d(s),f,h,u),s}return a(i,[{key:"getResolutionScale",value:function(){return this.resolutionScale}},{key:"setResolutionScale",value:function(e){this.resolutionScale=e,this.setSize(this.resolution.base.x,this.resolution.base.y)}},{key:"render",value:function(e,t,n,r,i){var a=this.renderToScreen?null:this.renderTarget;this.renderPass.render(e,a)}},{key:"setSize",value:function(e,t){var n=this.resolution;n.base.set(e,t),this.renderTarget.setSize(n.width,n.height)}},{key:"texture",get:function(){return this.renderTarget.texture}}]),i}(te),ce=function(e){s(i,e);var n=h(i);function i(){var e,a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},s=a.normalBuffer,o=void 0===s?null:s,l=a.resolutionScale,u=void 0===l?.5:l,c=a.width,f=void 0===c?$.AUTO_SIZE:c,v=a.height,h=void 0===v?$.AUTO_SIZE:v;if(r(this,i),(e=n.call(this,"DepthDownsamplingPass")).setFullscreenMaterial(new B),e.needsDepthTexture=!0,e.needsSwap=!1,null!==o){var p=e.getFullscreenMaterial();p.uniforms.normalBuffer.value=o,p.defines.DOWNSAMPLE_NORMALS="1"}return e.renderTarget=new t.WebGLRenderTarget(1,1,{minFilter:t.NearestFilter,magFilter:t.NearestFilter,stencilBuffer:!1,depthBuffer:!1,type:t.FloatType}),e.renderTarget.texture.name="DepthDownsamplingPass.Target",e.renderTarget.texture.generateMipmaps=!1,e.resolution=new $(d(e),f,h),e.resolution.scale=u,e}return a(i,[{key:"setDepthTexture",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=this.getFullscreenMaterial();n.uniforms.depthBuffer.value=e,n.depthPacking=t}},{key:"render",value:function(e,t,n,r,i){e.setRenderTarget(this.renderToScreen?null:this.renderTarget),e.render(this.scene,this.camera)}},{key:"setSize",value:function(e,t){var n=this.resolution;n.base.set(e,t),this.getFullscreenMaterial().setTexelSize(1/e,1/t),this.renderTarget.setSize(n.width,n.height)}},{key:"initialize",value:function(e,t,n){e.capabilities.isWebGL2||console.error("The DepthDownsamplingPass requires WebGL 2")}},{key:"texture",get:function(){return this.renderTarget.texture}}]),i}(te),fe={SKIP:0,ADD:1,ALPHA:2,AVERAGE:3,COLOR_BURN:4,COLOR_DODGE:5,DARKEN:6,DIFFERENCE:7,EXCLUSION:8,LIGHTEN:9,MULTIPLY:10,DIVIDE:11,NEGATION:12,NORMAL:13,OVERLAY:14,REFLECT:15,SCREEN:16,SOFT_LIGHT:17,SUBTRACT:18},de=new Map([[fe.SKIP,null],[fe.ADD,"vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return min(x+y,1.0)*opacity+x*(1.0-opacity);}"],[fe.ALPHA,"vec3 blend(const in vec3 x,const in vec3 y,const in float opacity){return y*opacity+x*(1.0-opacity);}vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){float a=min(y.a,opacity);return vec4(blend(x.rgb,y.rgb,a),max(x.a,a));}"],[fe.AVERAGE,"vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return(x+y)*0.5*opacity+x*(1.0-opacity);}"],[fe.COLOR_BURN,"float blend(const in float x,const in float y){return(y==0.0)? y : max(1.0-(1.0-x)/y,0.0);}vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){vec4 z=vec4(blend(x.r,y.r),blend(x.g,y.g),blend(x.b,y.b),blend(x.a,y.a));return z*opacity+x*(1.0-opacity);}"],[fe.COLOR_DODGE,"float blend(const in float x,const in float y){return(y==1.0)? y : min(x/(1.0-y),1.0);}vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){vec4 z=vec4(blend(x.r,y.r),blend(x.g,y.g),blend(x.b,y.b),blend(x.a,y.a));return z*opacity+x*(1.0-opacity);}"],[fe.DARKEN,"vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return min(x,y)*opacity+x*(1.0-opacity);}"],[fe.DIFFERENCE,"vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return abs(x-y)*opacity+x*(1.0-opacity);}"],[fe.EXCLUSION,"vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return(x+y-2.0*x*y)*opacity+x*(1.0-opacity);}"],[fe.LIGHTEN,"vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return max(x,y)*opacity+x*(1.0-opacity);}"],[fe.MULTIPLY,"vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return x*y*opacity+x*(1.0-opacity);}"],[fe.DIVIDE,"float blend(const in float x,const in float y){return(y>0.0)? min(x/y,1.0): 1.0;}vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){vec4 z=vec4(blend(x.r,y.r),blend(x.g,y.g),blend(x.b,y.b),blend(x.a,y.a));return z*opacity+x*(1.0-opacity);}"],[fe.NEGATION,"vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return(1.0-abs(1.0-x-y))*opacity+x*(1.0-opacity);}"],[fe.NORMAL,"vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return y*opacity+x*(1.0-opacity);}"],[fe.OVERLAY,"float blend(const in float x,const in float y){return(x<0.5)?(2.0*x*y):(1.0-2.0*(1.0-x)*(1.0-y));}vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){vec4 z=vec4(blend(x.r,y.r),blend(x.g,y.g),blend(x.b,y.b),blend(x.a,y.a));return z*opacity+x*(1.0-opacity);}"],[fe.REFLECT,"float blend(const in float x,const in float y){return(y==1.0)? y : min(x*x/(1.0-y),1.0);}vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){vec4 z=vec4(blend(x.r,y.r),blend(x.g,y.g),blend(x.b,y.b),blend(x.a,y.a));return z*opacity+x*(1.0-opacity);}"],[fe.SCREEN,"vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return(1.0-(1.0-x)*(1.0-y))*opacity+x*(1.0-opacity);}"],[fe.SOFT_LIGHT,"float blend(const in float x,const in float y){return(y<0.5)?(2.0*x*y+x*x*(1.0-2.0*y)):(sqrt(x)*(2.0*y-1.0)+2.0*x*(1.0-y));}vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){vec4 z=vec4(blend(x.r,y.r),blend(x.g,y.g),blend(x.b,y.b),blend(x.a,y.a));return z*opacity+x*(1.0-opacity);}"],[fe.SUBTRACT,"vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return max(x+y-1.0,0.0)*opacity+x*(1.0-opacity);}"]]),ve=function(e){s(i,e);var n=h(i);function i(e){var a,s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;return r(this,i),(a=n.call(this)).blendFunction=e,a.opacity=new t.Uniform(s),a}return a(i,[{key:"getBlendFunction",value:function(){return this.blendFunction}},{key:"setBlendFunction",value:function(e){this.blendFunction=e,this.dispatchEvent({type:"change"})}},{key:"getShaderCode",value:function(){return de.get(this.blendFunction)}}]),i}(t.EventDispatcher),he=function(e){s(i,e);var n=h(i);function i(e,t){var a,s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},o=s.attributes,l=void 0===o?pe.NONE:o,u=s.blendFunction,c=void 0===u?fe.SCREEN:u,f=s.defines,d=void 0===f?new Map:f,v=s.uniforms,h=void 0===v?new Map:v,p=s.extensions,g=void 0===p?null:p,m=s.vertexShader,y=void 0===m?null:m;return r(this,i),(a=n.call(this)).name=e,a.attributes=l,a.fragmentShader=t,a.vertexShader=y,a.defines=d,a.uniforms=h,a.extensions=g,a.blendMode=new ve(c),a.blendMode.addEventListener("change",(function(e){return a.setChanged()})),a}return a(i,[{key:"setChanged",value:function(){this.dispatchEvent({type:"change"})}},{key:"getAttributes",value:function(){return this.attributes}},{key:"setAttributes",value:function(e){this.attributes=e,this.setChanged()}},{key:"getFragmentShader",value:function(){return this.fragmentShader}},{key:"setFragmentShader",value:function(e){this.fragmentShader=e,this.setChanged()}},{key:"getVertexShader",value:function(){return this.vertexShader}},{key:"setVertexShader",value:function(e){this.vertexShader=e,this.setChanged()}},{key:"setDepthTexture",value:function(e){}},{key:"update",value:function(e,t,n){}},{key:"setSize",value:function(e,t){}},{key:"initialize",value:function(e,t,n){}},{key:"dispose",value:function(){for(var e=0,n=Object.keys(this);e<n.length;e++){var r=n[e],i=this[r];if(null!==i&&"function"==typeof i.dispose){if(i instanceof t.Scene)continue;this[r].dispose()}}}}]),i}(t.EventDispatcher),pe={NONE:0,DEPTH:1,CONVOLUTION:2};function ge(e,t){for(var n,r=[];null!==(n=e.exec(t));)r.push(n[1]);return r}function me(e,t,n){var r,i,a,s=x(t);try{for(s.s();!(a=s.n()).done;){var o=a.value;r="$1"+e+o.charAt(0).toUpperCase()+o.slice(1),i=new RegExp("([^\\.])(\\b"+o+"\\b)","g");var l,u=x(n.entries());try{for(u.s();!(l=u.n()).done;){var c=l.value;null!==c[1]&&n.set(c[0],c[1].replace(i,r))}}catch(e){u.e(e)}finally{u.f()}}}catch(e){s.e(e)}finally{s.f()}}function ye(e,t,n,r,i,a,s){var o=/(?:\w+\s+(\w+)\([\w\s,]*\)\s*{[^}]+})/g,l=t.blendMode,u=new Map([["fragment",t.getFragmentShader()],["vertex",t.getVertexShader()]]),c=void 0!==u.get("fragment")&&u.get("fragment").indexOf("mainImage")>=0,f=void 0!==u.get("fragment")&&u.get("fragment").indexOf("mainUv")>=0,d=[],v=[],h=!1,p=!1;if(void 0===u.get("fragment"))console.error("Missing fragment shader",t);else if(f&&0!=(s&pe.CONVOLUTION))console.error("Effects that transform UV coordinates are incompatible with convolution effects",t);else if(c||f){if(f&&(n.set(G.FRAGMENT_MAIN_UV,n.get(G.FRAGMENT_MAIN_UV)+"\t"+e+"MainUv(UV);\n"),h=!0),null!==u.get("vertex")&&u.get("vertex").indexOf("mainSupport")>=0){var g="\t"+e+"MainSupport(";u.get("vertex").indexOf("uv")>=0&&(g+="vUv"),g+=");\n",n.set(G.VERTEX_MAIN_SUPPORT,n.get(G.VERTEX_MAIN_SUPPORT)+g),d=d.concat(ge(/(?:varying\s+\w+\s+(\w*))/g,u.get("vertex"))),v=v.concat(d).concat(ge(o,u.get("vertex")))}if(v=v.concat(ge(o,u.get("fragment"))).concat(Array.from(t.defines.keys()).map((function(e){return e.replace(/\([\w\s,]*\)/g,"")}))).concat(Array.from(t.uniforms.keys())),t.uniforms.forEach((function(t,n){return a.set(e+n.charAt(0).toUpperCase()+n.slice(1),t)})),t.defines.forEach((function(t,n){return i.set(e+n.charAt(0).toUpperCase()+n.slice(1),t)})),me(e,v,i),me(e,v,u),r.set(l.blendFunction,l),c){var m=e+"MainImage(color0, UV, ";0!=(s&pe.DEPTH)&&u.get("fragment").indexOf("depth")>=0&&(m+="depth, ",p=!0),m+="color1);\n\t";var y=e+"BlendOpacity";a.set(y,l.opacity),m+="color0 = blend"+l.getBlendFunction()+"(color0, color1, "+y+");\n\n\t",n.set(G.FRAGMENT_MAIN_IMAGE,n.get(G.FRAGMENT_MAIN_IMAGE)+m),n.set(G.FRAGMENT_HEAD,n.get(G.FRAGMENT_HEAD)+"uniform float "+y+";\n\n")}n.set(G.FRAGMENT_HEAD,n.get(G.FRAGMENT_HEAD)+u.get("fragment")+"\n"),null!==u.get("vertex")&&n.set(G.VERTEX_HEAD,n.get(G.VERTEX_HEAD)+u.get("vertex")+"\n")}else console.error("The fragment shader contains neither a mainImage nor a mainUv function",t);return{varyings:d,transformedUv:h,readDepth:p}}var Te=function(e){s(n,e);var t=h(n);function n(e){var i;r(this,n),(i=t.call(this,"EffectPass")).setFullscreenMaterial(new z(null,null,null,e));for(var a=arguments.length,s=new Array(a>1?a-1:0),o=1;o<a;o++)s[o-1]=arguments[o];return i.effects=s.sort((function(e,t){return t.attributes-e.attributes})),i.skipRendering=!1,i.uniforms=0,i.varyings=0,i.minTime=1,i.maxTime=Number.POSITIVE_INFINITY,i}return a(n,[{key:"verifyResources",value:function(e){var t=e.capabilities,n=Math.min(t.maxFragmentUniforms,t.maxVertexUniforms);this.uniforms>n&&console.warn("The current rendering context doesn't support more than "+n+" uniforms, but "+this.uniforms+" were defined"),n=t.maxVaryings,this.varyings>n&&console.warn("The current rendering context doesn't support more than "+n+" varyings, but "+this.varyings+" were defined")}},{key:"updateMaterial",value:function(){var e,t,n=/\bblend\b/g,r=new Map([[G.FRAGMENT_HEAD,""],[G.FRAGMENT_MAIN_UV,""],[G.FRAGMENT_MAIN_IMAGE,""],[G.VERTEX_HEAD,""],[G.VERTEX_MAIN_SUPPORT,""]]),i=new Map,a=new Map,s=new Map,o=new Set,l=0,u=0,c=0,f=!1,d=!1,v=x(this.effects);try{for(v.s();!(t=v.n()).done;){var h=t.value;if(h.blendMode.getBlendFunction()===fe.SKIP)c|=h.getAttributes()&pe.DEPTH;else if(0!=(c&pe.CONVOLUTION)&&0!=(h.getAttributes()&pe.CONVOLUTION))console.error("Convolution effects cannot be merged",h);else if(c|=h.getAttributes(),u+=(e=ye("e"+l++,h,r,i,a,s,c)).varyings.length,f=f||e.transformedUv,d=d||e.readDepth,null!==h.extensions){var p,g=x(h.extensions);try{for(g.s();!(p=g.n()).done;){var m=p.value;o.add(m)}}catch(e){g.e(e)}finally{g.f()}}}}catch(e){v.e(e)}finally{v.f()}var y,T=x(i.values());try{for(T.s();!(y=T.n()).done;){var E=y.value;r.set(G.FRAGMENT_HEAD,r.get(G.FRAGMENT_HEAD)+E.getShaderCode().replace(n,"blend"+E.getBlendFunction())+"\n")}}catch(e){T.e(e)}finally{T.f()}0!=(c&pe.DEPTH)?(d&&r.set(G.FRAGMENT_MAIN_IMAGE,"float depth = readDepth(UV);\n\n\t"+r.get(G.FRAGMENT_MAIN_IMAGE)),this.needsDepthTexture=null===this.getDepthTexture()):this.needsDepthTexture=!1,f?(r.set(G.FRAGMENT_MAIN_UV,"vec2 transformedUv = vUv;\n"+r.get(G.FRAGMENT_MAIN_UV)),a.set("UV","transformedUv")):a.set("UV","vUv"),r.forEach((function(e,t,n){return n.set(t,e.trim().replace(/^#/,"\n#"))})),this.uniforms=s.size,this.varyings=u,this.skipRendering=0===l,this.needsSwap=!this.skipRendering;var S=this.getFullscreenMaterial();if(S.setShaderParts(r).setDefines(a).setUniforms(s),S.extensions={},o.size>0){var b,D=x(o);try{for(D.s();!(b=D.n()).done;){var M=b.value;S.extensions[M]=!0}}catch(e){D.e(e)}finally{D.f()}}this.needsUpdate=!1}},{key:"recompile",value:function(e){this.updateMaterial(),void 0!==e&&this.verifyResources(e)}},{key:"getDepthTexture",value:function(){return this.getFullscreenMaterial().uniforms.depthBuffer.value}},{key:"setDepthTexture",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=this.getFullscreenMaterial();n.uniforms.depthBuffer.value=e,n.depthPacking=t,n.needsUpdate=!0;var r,i=x(this.effects);try{for(i.s();!(r=i.n()).done;){var a=r.value;a.setDepthTexture(e,t)}}catch(e){i.e(e)}finally{i.f()}}},{key:"render",value:function(e,t,n,r,i){var a=this.getFullscreenMaterial(),s=a.uniforms.time.value+r;this.needsUpdate&&this.recompile(e);var o,l=x(this.effects);try{for(l.s();!(o=l.n()).done;){o.value.update(e,t,r)}}catch(e){l.e(e)}finally{l.f()}this.skipRendering&&!this.renderToScreen||(a.uniforms.inputBuffer.value=t.texture,a.uniforms.time.value=s<=this.maxTime?s:this.minTime,e.setRenderTarget(this.renderToScreen?null:n),e.render(this.scene,this.camera))}},{key:"setSize",value:function(e,t){this.getFullscreenMaterial().setSize(e,t);var n,r=x(this.effects);try{for(r.s();!(n=r.n()).done;){n.value.setSize(e,t)}}catch(e){r.e(e)}finally{r.f()}}},{key:"initialize",value:function(e,t,n){var r=this;this.capabilities=e.capabilities;var i,a=x(this.effects);try{for(a.s();!(i=a.n()).done;){var s=i.value;s.initialize(e,t,n),s.addEventListener("change",(function(e){return r.handleEvent(e)}))}}catch(e){a.e(e)}finally{a.f()}this.updateMaterial(),this.verifyResources(e)}},{key:"dispose",value:function(){g(o(n.prototype),"dispose",this).call(this);var e,t=x(this.effects);try{for(t.s();!(e=t.n()).done;){e.value.dispose()}}catch(e){t.e(e)}finally{t.f()}}},{key:"handleEvent",value:function(e){switch(e.type){case"change":this.needsUpdate=!0}}},{key:"encodeOutput",get:function(){return void 0!==this.getFullscreenMaterial().defines.ENCODE_OUTPUT},set:function(e){if(this.encodeOutput!==e){var t=this.getFullscreenMaterial();t.needsUpdate=!0,e?t.defines.ENCODE_OUTPUT="1":delete t.defines.ENCODE_OUTPUT}}},{key:"dithering",get:function(){return this.getFullscreenMaterial().dithering},set:function(e){var t=this.getFullscreenMaterial();t.dithering!==e&&(t.dithering=e,t.needsUpdate=!0)}}]),n}(te),xe=function(e){s(n,e);var t=h(n);function n(e){var i;return r(this,n),(i=t.call(this,"LambdaPass",null,null)).needsSwap=!1,i.f=e,i}return a(n,[{key:"render",value:function(e,t,n,r,i){this.f()}}]),n}(te),Ee=function(e){s(n,e);var t=h(n);function n(e,i){var a;return r(this,n),(a=t.call(this,"MaskPass",e,i)).needsSwap=!1,a.clearPass=new ae(!1,!1,!0),a.inverse=!1,a}return a(n,[{key:"render",value:function(e,t,n,r,i){var a=e.getContext(),s=e.state.buffers,o=this.scene,l=this.camera,u=this.clearPass,c=this.inverse?0:1,f=1-c;s.color.setMask(!1),s.depth.setMask(!1),s.color.setLocked(!0),s.depth.setLocked(!0),s.stencil.setTest(!0),s.stencil.setOp(a.REPLACE,a.REPLACE,a.REPLACE),s.stencil.setFunc(a.ALWAYS,c,4294967295),s.stencil.setClear(f),s.stencil.setLocked(!0),this.clear&&(this.renderToScreen?u.render(e,null):(u.render(e,t),u.render(e,n))),this.renderToScreen?(e.setRenderTarget(null),e.render(o,l)):(e.setRenderTarget(t),e.render(o,l),e.setRenderTarget(n),e.render(o,l)),s.color.setLocked(!1),s.depth.setLocked(!1),s.stencil.setLocked(!1),s.stencil.setFunc(a.EQUAL,1,4294967295),s.stencil.setOp(a.KEEP,a.KEEP,a.KEEP),s.stencil.setLocked(!0)}},{key:"clear",get:function(){return this.clearPass.enabled},set:function(e){this.clearPass.enabled=e}}]),n}(te),Se=function(e){s(i,e);var n=h(i);function i(e,a){var s,o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},l=o.resolutionScale,u=void 0===l?1:l,c=o.width,f=void 0===c?$.AUTO_SIZE:c,v=o.height,h=void 0===v?$.AUTO_SIZE:v,p=o.renderTarget;r(this,i),(s=n.call(this,"NormalPass")).needsSwap=!1,s.renderPass=new le(e,a,new t.MeshNormalMaterial);var g=s.renderPass.getClearPass();return g.overrideClearColor=new t.Color(7829503),g.overrideClearAlpha=1,s.renderTarget=p,void 0===s.renderTarget&&(s.renderTarget=new t.WebGLRenderTarget(1,1,{minFilter:t.NearestFilter,magFilter:t.NearestFilter,format:t.RGBFormat,stencilBuffer:!1}),s.renderTarget.texture.name="NormalPass.Target"),s.resolution=new $(d(s),f,h,u),s}return a(i,[{key:"getResolutionScale",value:function(){return this.resolutionScale}},{key:"setResolutionScale",value:function(e){this.resolutionScale=e,this.setSize(this.resolution.base.x,this.resolution.base.y)}},{key:"render",value:function(e,t,n,r,i){var a=this.renderToScreen?null:this.renderTarget;this.renderPass.render(e,a,a)}},{key:"setSize",value:function(e,t){var n=this.resolution;n.base.set(e,t),this.renderTarget.setSize(n.width,n.height)}},{key:"texture",get:function(){return this.renderTarget.texture}}]),i}(te),be=function(e){s(i,e);var n=h(i);function i(e){var a,s=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return r(this,i),(a=n.call(this,"SavePass")).setFullscreenMaterial(new C),a.needsSwap=!1,a.renderTarget=e,void 0===e&&(a.renderTarget=new t.WebGLRenderTarget(1,1,{minFilter:t.LinearFilter,magFilter:t.LinearFilter,stencilBuffer:!1,depthBuffer:!1}),a.renderTarget.texture.name="SavePass.Target"),a.resize=s,a}return a(i,[{key:"render",value:function(e,t,n,r,i){this.getFullscreenMaterial().uniforms.inputBuffer.value=t.texture,e.setRenderTarget(this.renderToScreen?null:this.renderTarget),e.render(this.scene,this.camera)}},{key:"setSize",value:function(e,t){if(this.resize){var n=Math.max(e,1),r=Math.max(t,1);this.renderTarget.setSize(n,r)}}},{key:"initialize",value:function(e,n,r){n||r!==t.UnsignedByteType||(this.renderTarget.texture.format=t.RGBFormat),void 0!==r&&(this.renderTarget.texture.type=r)}},{key:"texture",get:function(){return this.renderTarget.texture}}]),i}(te),De=function(e){s(n,e);var t=h(n);function n(e){var i,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"inputBuffer";return r(this,n),(i=t.call(this,"ShaderPass")).setFullscreenMaterial(e),i.uniform=null,i.setInput(a),i}return a(n,[{key:"setInput",value:function(e){var t=this.getFullscreenMaterial();if(this.uniform=null,null!==t){var n=t.uniforms;void 0!==n&&void 0!==n[e]&&(this.uniform=n[e])}}},{key:"render",value:function(e,t,n,r,i){null!==this.uniform&&null!==t&&(this.uniform.value=t.texture),e.setRenderTarget(this.renderToScreen?null:n),e.render(this.scene,this.camera)}}]),n}(te),Me=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=n.depthBuffer,a=void 0===i||i,s=n.stencilBuffer,o=void 0!==s&&s,l=n.multisampling,u=void 0===l?0:l,c=n.frameBufferType;r(this,e),this.renderer=t,this.inputBuffer=null,this.outputBuffer=null,null!==this.renderer&&(this.renderer.autoClear=!1,this.inputBuffer=this.createBuffer(a,o,c,u),this.outputBuffer=this.inputBuffer.clone(),this.enableExtensions()),this.copyPass=new De(new C),this.depthTexture=null,this.passes=[],this.autoRenderToScreen=!0}return a(e,[{key:"getRenderer",value:function(){return this.renderer}},{key:"enableExtensions",value:function(){var e=this.inputBuffer.texture.type,n=this.renderer.capabilities,r=this.renderer.getContext();e!==t.UnsignedByteType&&(n.isWebGL2?r.getExtension("EXT_color_buffer_float"):r.getExtension("EXT_color_buffer_half_float"))}},{key:"replaceRenderer",value:function(e){var n=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],r=this.renderer;if(null!==r&&r!==e){var i=r.getSize(new t.Vector2),a=e.getSize(new t.Vector2),s=r.domElement.parentNode;this.renderer=e,this.renderer.autoClear=!1,i.equals(a)||this.setSize(),n&&null!==s&&(s.removeChild(r.domElement),s.appendChild(e.domElement)),this.enableExtensions()}return r}},{key:"createDepthTexture",value:function(){var e=this.depthTexture=new t.DepthTexture;return this.inputBuffer.depthTexture=e,this.inputBuffer.dispose(),this.inputBuffer.stencilBuffer?(e.format=t.DepthStencilFormat,e.type=t.UnsignedInt248Type):e.type=t.UnsignedIntType,e}},{key:"deleteDepthTexture",value:function(){if(null!==this.depthTexture){this.depthTexture.dispose(),this.depthTexture=null,this.inputBuffer.depthTexture=null,this.inputBuffer.dispose();var e,t=x(this.passes);try{for(t.s();!(e=t.n()).done;){e.value.setDepthTexture(null)}}catch(e){t.e(e)}finally{t.f()}}}},{key:"createBuffer",value:function(e,n,r,i){var a=this.renderer.getDrawingBufferSize(new t.Vector2),s={format:this.renderer.getContext().getContextAttributes().alpha||r!==t.UnsignedByteType?t.RGBAFormat:t.RGBFormat,minFilter:t.LinearFilter,magFilter:t.LinearFilter,stencilBuffer:n,depthBuffer:e,type:r},o=i>0?new t.WebGLMultisampleRenderTarget(a.width,a.height,s):new t.WebGLRenderTarget(a.width,a.height,s);return i>0&&(o.samples=i),o.texture.name="EffectComposer.Buffer",o.texture.generateMipmaps=!1,o}},{key:"addPass",value:function(e,n){var r=this.passes,i=this.renderer,a=i.getContext().getContextAttributes().alpha,s=this.inputBuffer.texture.type,o=i.getDrawingBufferSize(new t.Vector2);if(e.setSize(o.width,o.height),e.initialize(i,a,s),this.autoRenderToScreen&&(r.length>0&&(r[r.length-1].renderToScreen=!1),e.renderToScreen&&(this.autoRenderToScreen=!1)),void 0!==n?r.splice(n,0,e):r.push(e),this.autoRenderToScreen&&(r[r.length-1].renderToScreen=!0),e.needsDepthTexture||null!==this.depthTexture)if(null===this.depthTexture){var l,u=this.createDepthTexture(),c=x(r);try{for(c.s();!(l=c.n()).done;)(e=l.value).setDepthTexture(u)}catch(e){c.e(e)}finally{c.f()}}else e.setDepthTexture(this.depthTexture)}},{key:"removePass",value:function(e){var t=this.passes,n=t.indexOf(e);if(t.splice(n,1).length>0){if(null!==this.depthTexture){t.reduce((function(e,t){return e||t.needsDepthTexture}),!1)||(e.getDepthTexture()===this.depthTexture&&e.setDepthTexture(null),this.deleteDepthTexture())}this.autoRenderToScreen&&n===t.length&&(e.renderToScreen=!1,t.length>0&&(t[t.length-1].renderToScreen=!0))}}},{key:"removeAllPasses",value:function(){var e=this.passes;this.deleteDepthTexture(),e.length>0&&(this.autoRenderToScreen&&(e[e.length-1].renderToScreen=!1),this.passes=[])}},{key:"render",value:function(e){var t,n,r,i,a=this.renderer,s=this.copyPass,o=this.inputBuffer,l=this.outputBuffer,u=!1,c=x(this.passes);try{for(c.s();!(i=c.n()).done;){var f=i.value;f.enabled&&(f.render(a,o,l,e,u),f.needsSwap&&(u&&(s.renderToScreen=f.renderToScreen,t=a.getContext(),(n=a.state.buffers.stencil).setFunc(t.NOTEQUAL,1,4294967295),s.render(a,o,l,e,u),n.setFunc(t.EQUAL,1,4294967295)),r=o,o=l,l=r),f instanceof Ee?u=!0:f instanceof re&&(u=!1))}}catch(e){c.e(e)}finally{c.f()}}},{key:"setSize",value:function(e,n,r){var i=this.renderer;if(void 0===e||void 0===n){var a=i.getSize(new t.Vector2);e=a.width,n=a.height}else i.setSize(e,n,r);var s=i.getDrawingBufferSize(new t.Vector2);this.inputBuffer.setSize(s.width,s.height),this.outputBuffer.setSize(s.width,s.height);var o,l=x(this.passes);try{for(l.s();!(o=l.n()).done;){o.value.setSize(s.width,s.height)}}catch(e){l.e(e)}finally{l.f()}}},{key:"reset",value:function(){this.dispose(),this.autoRenderToScreen=!0}},{key:"dispose",value:function(){var e,t=x(this.passes);try{for(t.s();!(e=t.n()).done;){e.value.dispose()}}catch(e){t.e(e)}finally{t.f()}this.passes=[],null!==this.inputBuffer&&this.inputBuffer.dispose(),null!==this.outputBuffer&&this.outputBuffer.dispose(),this.deleteDepthTexture(),this.copyPass.dispose()}},{key:"multisampling",get:function(){return this.inputBuffer instanceof t.WebGLMultisampleRenderTarget?this.inputBuffer.samples:0},set:function(e){var t=this.inputBuffer,n=this.multisampling;n>0&&e>0?(this.inputBuffer.samples=e,this.outputBuffer.samples=e):n!==e&&(this.inputBuffer.dispose(),this.outputBuffer.dispose(),this.inputBuffer=this.createBuffer(t.depthBuffer,t.stencilBuffer,t.texture.type,e),this.inputBuffer.depthTexture=this.depthTexture,this.outputBuffer=this.inputBuffer.clone())}}]),e}(),ke=function(){function e(){r(this,e)}return a(e,[{key:"initialize",value:function(e,t,n){}}]),e}(),Ae=function(){function e(){r(this,e)}return a(e,[{key:"setSize",value:function(e,t){}}]),e}(),Ue=function(e){s(n,e);var t=h(n);function n(e){var i,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:10;return r(this,n),(i=t.call(this)).currentLayer=a,void 0!==e&&i.set(e),i}return a(n,[{key:"clear",value:function(){var e,t=this.layer,r=x(this);try{for(r.s();!(e=r.n()).done;){e.value.layers.disable(t)}}catch(e){r.e(e)}finally{r.f()}return g(o(n.prototype),"clear",this).call(this)}},{key:"set",value:function(e){this.clear();var t,n=x(e);try{for(n.s();!(t=n.n()).done;){var r=t.value;this.add(r)}}catch(e){n.e(e)}finally{n.f()}return this}},{key:"indexOf",value:function(e){return this.has(e)?0:-1}},{key:"add",value:function(e){return e.layers.enable(this.layer),g(o(n.prototype),"add",this).call(this,e),this}},{key:"delete",value:function(e){return this.has(e)&&e.layers.disable(this.layer),g(o(n.prototype),"delete",this).call(this,e)}},{key:"setVisible",value:function(e){var t,n=x(this);try{for(n.s();!(t=n.n()).done;){var r=t.value;e?r.layers.enable(0):r.layers.disable(0)}}catch(e){n.e(e)}finally{n.f()}return this}},{key:"layer",get:function(){return this.currentLayer},set:function(e){var t,n=this.currentLayer,r=x(this);try{for(r.s();!(t=r.n()).done;){var i=t.value;i.layers.disable(n),i.layers.enable(e)}}catch(e){r.e(e)}finally{r.f()}this.currentLayer=e}}]),n}(f(Set)),Pe="uniform sampler2D texture;uniform float intensity;void mainImage(const in vec4 inputColor,const in vec2 uv,out vec4 outputColor){outputColor=clamp(texture2D(texture,uv)*intensity,0.0,1.0);}",we=function(e){s(i,e);var n=h(i);function i(){var e,a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},s=a.blendFunction,o=void 0===s?fe.SCREEN:s,l=a.luminanceThreshold,u=void 0===l?.9:l,c=a.luminanceSmoothing,f=void 0===c?.025:c,v=a.resolutionScale,h=void 0===v?.5:v,p=a.intensity,g=void 0===p?1:p,m=a.width,y=void 0===m?$.AUTO_SIZE:m,T=a.height,x=void 0===T?$.AUTO_SIZE:T,E=a.kernelSize,S=void 0===E?R.LARGE:E;return r(this,i),(e=n.call(this,"BloomEffect",Pe,{blendFunction:o,uniforms:new Map([["texture",new t.Uniform(null)],["intensity",new t.Uniform(g)]])})).renderTarget=new t.WebGLRenderTarget(1,1,{minFilter:t.LinearFilter,magFilter:t.LinearFilter,stencilBuffer:!1,depthBuffer:!1}),e.renderTarget.texture.name="Bloom.Target",e.renderTarget.texture.generateMipmaps=!1,e.uniforms.get("texture").value=e.renderTarget.texture,e.blurPass=new ne({resolutionScale:h,width:y,height:x,kernelSize:S}),e.blurPass.resolution.resizable=d(e),e.luminancePass=new De(new H(!0)),e.luminanceMaterial.threshold=u,e.luminanceMaterial.smoothing=f,e}return a(i,[{key:"getResolutionScale",value:function(){return this.resolution.scale}},{key:"setResolutionScale",value:function(e){this.resolution.scale=e}},{key:"update",value:function(e,t,n){var r=this.renderTarget;this.luminancePass.enabled?(this.luminancePass.render(e,t,r),this.blurPass.render(e,r,r)):this.blurPass.render(e,t,r)}},{key:"setSize",value:function(e,t){this.blurPass.setSize(e,t),this.renderTarget.setSize(this.resolution.width,this.resolution.height)}},{key:"initialize",value:function(e,n,r){this.blurPass.initialize(e,n,r),n||r!==t.UnsignedByteType||(this.renderTarget.texture.format=t.RGBFormat),void 0!==r&&(this.renderTarget.texture.type=r)}},{key:"texture",get:function(){return this.renderTarget.texture}},{key:"luminanceMaterial",get:function(){return this.luminancePass.getFullscreenMaterial()}},{key:"resolution",get:function(){return this.blurPass.resolution}},{key:"width",get:function(){return this.resolution.width},set:function(e){this.resolution.width=e}},{key:"height",get:function(){return this.resolution.height},set:function(e){this.resolution.height=e}},{key:"dithering",get:function(){return this.blurPass.dithering},set:function(e){this.blurPass.dithering=e}},{key:"kernelSize",get:function(){return this.blurPass.kernelSize},set:function(e){this.blurPass.kernelSize=e}},{key:"distinction",get:function(){return console.warn(this.name,"The distinction field has been removed, use luminanceMaterial.threshold and luminanceMaterial.smoothing instead."),1},set:function(e){console.warn(this.name,"The distinction field has been removed, use luminanceMaterial.threshold and luminanceMaterial.smoothing instead.")}},{key:"intensity",get:function(){return this.uniforms.get("intensity").value},set:function(e){this.uniforms.get("intensity").value=e}}]),i}(he),Re="uniform vec2 angle;uniform float scale;float pattern(const in vec2 uv){vec2 point=scale*vec2(dot(angle.yx,vec2(uv.x,-uv.y)),dot(angle,uv));return(sin(point.x)*sin(point.y))*4.0;}void mainImage(const in vec4 inputColor,const in vec2 uv,out vec4 outputColor){vec3 color=vec3(inputColor.rgb*10.0-5.0+pattern(uv*resolution));outputColor=vec4(color,inputColor.a);}",Ce=function(e){s(i,e);var n=h(i);function i(){var e,a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},s=a.blendFunction,o=void 0===s?fe.NORMAL:s,l=a.angle,u=void 0===l?.5*Math.PI:l,c=a.scale,f=void 0===c?1:c;return r(this,i),(e=n.call(this,"DotScreenEffect",Re,{blendFunction:o,uniforms:new Map([["angle",new t.Uniform(new t.Vector2)],["scale",new t.Uniform(f)]])})).setAngle(u),e}return a(i,[{key:"setAngle",value:function(e){this.uniforms.get("angle").value.set(Math.sin(e),Math.cos(e))}}]),i}(he);function _e(e,n,r){var i,a=new Map([[t.LuminanceFormat,1],[t.RedFormat,1],[t.RGFormat,2],[t.RGBFormat,3],[t.RGBAFormat,4]]);if(a.has(n)||console.error("Invalid noise texture format"),r===t.UnsignedByteType)for(var s=0,o=(i=new Uint8Array(e*a.get(n))).length;s<o;++s)i[s]=255*Math.random();else for(var l=0,u=(i=new Float32Array(e*a.get(n))).length;l<u;++l)i[l]=Math.random();return i}var Oe=function(e){s(i,e);var n=h(i);function i(e,a){var s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:t.LuminanceFormat,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:t.UnsignedByteType;return r(this,i),n.call(this,_e(e*a,s,o),e,a,s,o)}return i}(t.DataTexture),Ne="uniform sampler2D perturbationMap;uniform bool active;uniform float columns;uniform float random;uniform vec2 seed;uniform vec2 distortion;void mainUv(inout vec2 uv){if(active){if(uv.y<distortion.x+columns&&uv.y>distortion.x-columns*random){float sx=clamp(ceil(seed.x),0.0,1.0);uv.y=sx*(1.0-(uv.y+distortion.y))+(1.0-sx)*distortion.y;}if(uv.x<distortion.y+columns&&uv.x>distortion.y-columns*random){float sy=clamp(ceil(seed.y),0.0,1.0);uv.x=sy*distortion.x+(1.0-sy)*(1.0-(uv.x+distortion.x));}vec2 normal=texture2D(perturbationMap,uv*random*random).rg;uv+=normal*seed*(random*0.2);}}",Be="Glitch.Generated";function Fe(e,t){return e+Math.random()*(t-e)}var Le=function(e){s(i,e);var n=h(i);function i(){var e,a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},s=a.blendFunction,o=void 0===s?fe.NORMAL:s,l=a.chromaticAberrationOffset,u=void 0===l?null:l,c=a.delay,f=void 0===c?new t.Vector2(1.5,3.5):c,d=a.duration,v=void 0===d?new t.Vector2(.6,1):d,h=a.strength,p=void 0===h?new t.Vector2(.3,1):h,g=a.columns,m=void 0===g?.05:g,y=a.ratio,T=void 0===y?.85:y,x=a.perturbationMap,E=void 0===x?null:x,S=a.dtSize,b=void 0===S?64:S;return r(this,i),(e=n.call(this,"GlitchEffect",Ne,{blendFunction:o,uniforms:new Map([["perturbationMap",new t.Uniform(null)],["columns",new t.Uniform(m)],["active",new t.Uniform(!1)],["random",new t.Uniform(1)],["seed",new t.Uniform(new t.Vector2)],["distortion",new t.Uniform(new t.Vector2)]])})).setPerturbationMap(null===E?e.generatePerturbationMap(b):E),e.delay=f,e.duration=v,e.breakPoint=new t.Vector2(Fe(e.delay.x,e.delay.y),Fe(e.duration.x,e.duration.y)),e.time=0,e.seed=e.uniforms.get("seed").value,e.distortion=e.uniforms.get("distortion").value,e.mode=Ie.SPORADIC,e.strength=p,e.ratio=T,e.chromaticAberrationOffset=u,e}return a(i,[{key:"getPerturbationMap",value:function(){return this.uniforms.get("perturbationMap").value}},{key:"setPerturbationMap",value:function(e){var n=this.getPerturbationMap();null!==n&&n.name===Be&&n.dispose(),e.minFilter=e.magFilter=t.NearestFilter,e.wrapS=e.wrapT=t.RepeatWrapping,e.generateMipmaps=!1,this.uniforms.get("perturbationMap").value=e}},{key:"generatePerturbationMap",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:64,n=new Oe(e,e,t.RGBFormat);return n.name=Be,n}},{key:"update",value:function(e,t,n){var r,i=this.mode,a=this.breakPoint,s=this.chromaticAberrationOffset,o=this.strength,l=this.time,u=!1,c=0,f=0;i!==Ie.DISABLED&&(i===Ie.SPORADIC&&(r=(l+=n)>a.x,l>=a.x+a.y&&(a.set(Fe(this.delay.x,this.delay.y),Fe(this.duration.x,this.duration.y)),l=0)),c=Math.random(),this.uniforms.get("random").value=c,r&&c>this.ratio||i===Ie.CONSTANT_WILD?(u=!0,c*=.03*o.y,f=Fe(-Math.PI,Math.PI),this.seed.set(Fe(-o.y,o.y),Fe(-o.y,o.y)),this.distortion.set(Fe(0,1),Fe(0,1))):(r||i===Ie.CONSTANT_MILD)&&(u=!0,c*=.03*o.x,f=Fe(-Math.PI,Math.PI),this.seed.set(Fe(-o.x,o.x),Fe(-o.x,o.x)),this.distortion.set(Fe(0,1),Fe(0,1))),this.time=l),null!==s&&(u?s.set(Math.cos(f),Math.sin(f)).multiplyScalar(c):s.set(0,0)),this.uniforms.get("active").value=u}},{key:"active",get:function(){return this.uniforms.get("active").value}}]),i}(he),Ie={DISABLED:0,SPORADIC:1,CONSTANT_MILD:2,CONSTANT_WILD:3},ze="void mainImage(const in vec4 inputColor,const in vec2 uv,out vec4 outputColor){vec3 noise=vec3(rand(uv*time));\n#ifdef PREMULTIPLY\noutputColor=vec4(min(inputColor.rgb*noise,vec3(1.0)),inputColor.a);\n#else\noutputColor=vec4(noise,inputColor.a);\n#endif\n}",Ge=function(e){s(n,e);var t=h(n);function n(){var e,i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},a=i.blendFunction,s=void 0===a?fe.SCREEN:a,o=i.premultiply,l=void 0!==o&&o;return r(this,n),(e=t.call(this,"NoiseEffect",ze,{blendFunction:s})).premultiply=l,e}return a(n,[{key:"premultiply",get:function(){return this.defines.has("PREMULTIPLY")},set:function(e){this.premultiply!==e&&(e?this.defines.set("PREMULTIPLY","1"):this.defines.delete("PREMULTIPLY"),this.setChanged())}}]),n}(he),Ve="uniform sampler2D edgeTexture;uniform sampler2D maskTexture;uniform vec3 visibleEdgeColor;uniform vec3 hiddenEdgeColor;uniform float pulse;uniform float edgeStrength;\n#ifdef USE_PATTERN\nuniform sampler2D patternTexture;varying vec2 vUvPattern;\n#endif\nvoid mainImage(const in vec4 inputColor,const in vec2 uv,out vec4 outputColor){vec2 edge=texture2D(edgeTexture,uv).rg;vec2 mask=texture2D(maskTexture,uv).rg;\n#ifndef X_RAY\nedge.y=0.0;\n#endif\nedge*=(edgeStrength*mask.x*pulse);vec3 color=edge.x*visibleEdgeColor+edge.y*hiddenEdgeColor;float visibilityFactor=0.0;\n#ifdef USE_PATTERN\nvec4 patternColor=texture2D(patternTexture,vUvPattern);\n#ifdef X_RAY\nfloat hiddenFactor=0.5;\n#else\nfloat hiddenFactor=0.0;\n#endif\nvisibilityFactor=(1.0-mask.y>0.0)? 1.0 : hiddenFactor;visibilityFactor*=(1.0-mask.x)*patternColor.a;color+=visibilityFactor*patternColor.rgb;\n#endif\nfloat alpha=max(max(edge.x,edge.y),visibilityFactor);\n#ifdef ALPHA\noutputColor=vec4(color,alpha);\n#else\noutputColor=vec4(color,max(alpha,inputColor.a));\n#endif\n}",He=function(e){s(i,e);var n=h(i);function i(e,a){var s,o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},l=o.blendFunction,u=void 0===l?fe.SCREEN:l,c=o.patternTexture,f=void 0===c?null:c,v=o.edgeStrength,h=void 0===v?1:v,p=o.pulseSpeed,g=void 0===p?0:p,m=o.visibleEdgeColor,y=void 0===m?16777215:m,T=o.hiddenEdgeColor,x=void 0===T?2230538:T,E=o.resolutionScale,S=void 0===E?.5:E,b=o.width,D=void 0===b?$.AUTO_SIZE:b,M=o.height,k=void 0===M?$.AUTO_SIZE:M,A=o.kernelSize,U=void 0===A?R.VERY_SMALL:A,P=o.blur,w=void 0!==P&&P,C=o.xRay,_=void 0===C||C;r(this,i),(s=n.call(this,"OutlineEffect",Ve,{uniforms:new Map([["maskTexture",new t.Uniform(null)],["edgeTexture",new t.Uniform(null)],["edgeStrength",new t.Uniform(h)],["visibleEdgeColor",new t.Uniform(new t.Color(y))],["hiddenEdgeColor",new t.Uniform(new t.Color(x))],["pulse",new t.Uniform(1)],["patternScale",new t.Uniform(1)],["patternTexture",new t.Uniform(null)]])})).blendMode.addEventListener("change",(function(e){s.blendMode.getBlendFunction()===fe.ALPHA?s.defines.set("ALPHA","1"):s.defines.delete("ALPHA"),s.setChanged()})),s.blendMode.setBlendFunction(u),s.setPatternTexture(f),s.xRay=_,s.scene=e,s.camera=a,s.renderTargetMask=new t.WebGLRenderTarget(1,1,{minFilter:t.LinearFilter,magFilter:t.LinearFilter,stencilBuffer:!1,format:t.RGBFormat}),s.renderTargetMask.texture.name="Outline.Mask",s.uniforms.get("maskTexture").value=s.renderTargetMask.texture,s.renderTargetOutline=s.renderTargetMask.clone(),s.renderTargetOutline.texture.name="Outline.Edges",s.renderTargetOutline.depthBuffer=!1,s.renderTargetBlurredOutline=s.renderTargetOutline.clone(),s.renderTargetBlurredOutline.texture.name="Outline.BlurredEdges",s.clearPass=new ae,s.clearPass.overrideClearColor=new t.Color(0),s.clearPass.overrideClearAlpha=1,s.depthPass=new ue(e,a),s.maskPass=new le(e,a,new N(s.depthPass.texture,a));var O=s.maskPass.getClearPass();return O.overrideClearColor=new t.Color(16777215),O.overrideClearAlpha=1,s.blurPass=new ne({resolutionScale:S,width:D,height:k,kernelSize:U}),s.blurPass.resolution.resizable=d(s),s.blur=w,s.outlinePass=new De(new Y),s.outlinePass.getFullscreenMaterial().uniforms.inputBuffer.value=s.renderTargetMask.texture,s.time=0,s.selection=new Ue,s.pulseSpeed=g,s}return a(i,[{key:"setPatternTexture",value:function(e){null!==e?(e.wrapS=e.wrapT=t.RepeatWrapping,this.defines.set("USE_PATTERN","1"),this.uniforms.get("patternTexture").value=e,this.setVertexShader("uniform float patternScale;varying vec2 vUvPattern;void mainSupport(const in vec2 uv){vUvPattern=uv*vec2(aspect,1.0)*patternScale;}")):(this.defines.delete("USE_PATTERN"),this.uniforms.get("patternTexture").value=null,this.setVertexShader(null)),this.setChanged()}},{key:"getResolutionScale",value:function(){return this.resolution.scale}},{key:"setResolutionScale",value:function(e){this.resolution.scale=e}},{key:"setSelection",value:function(e){return this.selection.set(e),this}},{key:"clearSelection",value:function(){return this.selection.clear(),this}},{key:"selectObject",value:function(e){return this.selection.add(e),this}},{key:"deselectObject",value:function(e){return this.selection.delete(e),this}},{key:"update",value:function(e,t,n){var r=this.scene,i=this.camera,a=this.selection,s=this.uniforms.get("pulse"),o=r.background,l=i.layers.mask;a.size>0?(r.background=null,s.value=1,this.pulseSpeed>0&&(s.value=.625+.375*Math.cos(this.time*this.pulseSpeed*10)),this.time+=n,a.setVisible(!1),this.depthPass.render(e),a.setVisible(!0),i.layers.set(a.layer),this.maskPass.render(e,this.renderTargetMask),i.layers.mask=l,r.background=o,this.outlinePass.render(e,null,this.renderTargetOutline),this.blur&&this.blurPass.render(e,this.renderTargetOutline,this.renderTargetBlurredOutline)):this.time>0&&(this.clearPass.render(e,this.renderTargetMask),this.time=0)}},{key:"setSize",value:function(e,t){this.blurPass.setSize(e,t),this.renderTargetMask.setSize(e,t);var n=this.resolution.width,r=this.resolution.height;this.depthPass.setSize(n,r),this.renderTargetOutline.setSize(n,r),this.renderTargetBlurredOutline.setSize(n,r),this.outlinePass.getFullscreenMaterial().setTexelSize(1/n,1/r)}},{key:"initialize",value:function(e,n,r){this.blurPass.initialize(e,n,t.UnsignedByteType),void 0!==r&&(this.depthPass.initialize(e,n,r),this.maskPass.initialize(e,n,r),this.outlinePass.initialize(e,n,r))}},{key:"resolution",get:function(){return this.blurPass.resolution}},{key:"width",get:function(){return this.resolution.width},set:function(e){this.resolution.width=e}},{key:"height",get:function(){return this.resolution.height},set:function(e){this.resolution.height=e}},{key:"selectionLayer",get:function(){return this.selection.layer},set:function(e){this.selection.layer=e}},{key:"dithering",get:function(){return this.blurPass.dithering},set:function(e){this.blurPass.dithering=e}},{key:"kernelSize",get:function(){return this.blurPass.kernelSize},set:function(e){this.blurPass.kernelSize=e}},{key:"blur",get:function(){return this.blurPass.enabled},set:function(e){this.blurPass.enabled=e,this.uniforms.get("edgeTexture").value=e?this.renderTargetBlurredOutline.texture:this.renderTargetOutline.texture}},{key:"xRay",get:function(){return this.defines.has("X_RAY")},set:function(e){this.xRay!==e&&(e?this.defines.set("X_RAY","1"):this.defines.delete("X_RAY"),this.setChanged())}}]),i}(he),je="uniform bool active;uniform vec2 d;void mainUv(inout vec2 uv){if(active){uv=vec2(d.x*(floor(uv.x/d.x)+0.5),d.y*(floor(uv.y/d.y)+0.5));}}",We=function(e){s(i,e);var n=h(i);function i(){var e,a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:30;return r(this,i),(e=n.call(this,"PixelationEffect",je,{uniforms:new Map([["active",new t.Uniform(!1)],["d",new t.Uniform(new t.Vector2)]])})).resolution=new t.Vector2,e.granularity=a,e}return a(i,[{key:"getGranularity",value:function(){return this.granularity}},{key:"setGranularity",value:function(e){(e=Math.floor(e))%2>0&&(e+=1);var t=this.uniforms;t.get("active").value=e>0,t.get("d").value.set(e,e).divide(this.resolution),this.granularity=e}},{key:"setSize",value:function(e,t){this.resolution.set(e,t),this.setGranularity(this.granularity)}}]),i}(he),Ke="uniform float count;void mainImage(const in vec4 inputColor,const in vec2 uv,out vec4 outputColor){vec2 sl=vec2(sin(uv.y*count),cos(uv.y*count));vec3 scanlines=vec3(sl.x,sl.y,sl.x);outputColor=vec4(scanlines,inputColor.a);}",Ze=function(e){s(i,e);var n=h(i);function i(){var e,a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},s=a.blendFunction,o=void 0===s?fe.OVERLAY:s,l=a.density,u=void 0===l?1.25:l;return r(this,i),(e=n.call(this,"ScanlineEffect",Ke,{blendFunction:o,uniforms:new Map([["count",new t.Uniform(0)]])})).resolution=new t.Vector2,e.density=u,e}return a(i,[{key:"getDensity",value:function(){return this.density}},{key:"setDensity",value:function(e){this.density=e,this.setSize(this.resolution.x,this.resolution.y)}},{key:"setSize",value:function(e,t){this.resolution.set(e,t),this.uniforms.get("count").value=Math.round(t*this.density)}}]),i}(he),Xe=function(e){s(i,e);var n=h(i);function i(e,a,s){var o,l,u;return r(this,i),(o=n.call(this,s)).scene=e,o.camera=a,o.clearPass=new ae(!0,!0,!1),o.clearPass.overrideClearColor=new t.Color(0),o.renderPass=new le(e,a),o.renderPass.clear=!1,o.blackoutPass=new le(e,a,new t.MeshBasicMaterial({color:0})),o.blackoutPass.clear=!1,o.backgroundPass=(l=new t.Scene,u=new le(l,a),l.background=e.background,u.clear=!1,u),o.renderTargetSelection=new t.WebGLRenderTarget(1,1,{minFilter:t.LinearFilter,magFilter:t.LinearFilter,stencilBuffer:!1,depthBuffer:!0}),o.renderTargetSelection.texture.name="Bloom.Selection",o.renderTargetSelection.texture.generateMipmaps=!1,o.selection=new Ue,o.inverted=!1,o}return a(i,[{key:"update",value:function(e,t,n){var r=this.scene,a=this.camera,s=this.selection,l=this.renderTargetSelection,u=r.background,c=a.layers.mask;this.clearPass.render(e,l),this.ignoreBackground||this.backgroundPass.render(e,l),r.background=null,this.inverted?(a.layers.set(s.layer),this.blackoutPass.render(e,l),a.layers.mask=c,s.setVisible(!1),this.renderPass.render(e,l),s.setVisible(!0)):(s.setVisible(!1),this.blackoutPass.render(e,l),s.setVisible(!0),a.layers.set(s.layer),this.renderPass.render(e,l),a.layers.mask=c),r.background=u,g(o(i.prototype),"update",this).call(this,e,l,n)}},{key:"setSize",value:function(e,t){g(o(i.prototype),"setSize",this).call(this,e,t),this.backgroundPass.setSize(e,t),this.blackoutPass.setSize(e,t),this.renderPass.setSize(e,t),this.renderTargetSelection.setSize(this.resolution.width,this.resolution.height)}},{key:"initialize",value:function(e,n,r){g(o(i.prototype),"initialize",this).call(this,e,n,r),this.backgroundPass.initialize(e,n,r),this.blackoutPass.initialize(e,n,r),this.renderPass.initialize(e,n,r),n||r!==t.UnsignedByteType||(this.renderTargetSelection.texture.format=t.RGBFormat),void 0!==r&&(this.renderTargetSelection.texture.type=r)}},{key:"ignoreBackground",get:function(){return!this.backgroundPass.enabled},set:function(e){this.backgroundPass.enabled=!e}}]),i}(we);var Ye=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;r(this,e),this.width=t,this.height=n,this.data=i}return a(e,[{key:"toCanvas",value:function(){return"undefined"==typeof document?null:(e=this.width,t=this.height,n=this.data,r=document.createElementNS("http://www.w3.org/1999/xhtml","canvas"),i=r.getContext("2d"),(a=i.createImageData(e,t)).data.set(n),r.width=e,r.height=t,i.putImageData(a,0,0),r);var e,t,n,r,i,a}}],[{key:"from",value:function(t){return new e(t.width,t.height,t.data)}}]),e}();e.AdaptiveLuminanceMaterial=b,e.BlendFunction=fe,e.BlendMode=ve,e.BloomEffect=we,e.BlurPass=ne,e.ClearMaskPass=re,e.ClearPass=ae,e.ColorChannel=n,e.ColorEdgesMaterial=k,e.ConvolutionMaterial=P,e.CopyMaterial=C,e.DepthComparisonMaterial=N,e.DepthDownsamplingMaterial=B,e.DepthDownsamplingPass=ce,e.DepthMaskMaterial=F,e.DepthPass=ue,e.Disposable=E,e.DotScreenEffect=Ce,e.EdgeDetectionMaterial=L,e.EdgeDetectionMode=I,e.Effect=he,e.EffectAttribute=pe,e.EffectComposer=Me,e.EffectMaterial=z,e.EffectPass=Te,e.GlitchEffect=Le,e.GlitchMode=Ie,e.Initializable=ke,e.KernelSize=R,e.LambdaPass=xe,e.LuminanceMaterial=H,e.MaskFunction=K,e.MaskMaterial=W,e.MaskPass=Ee,e.NoiseEffect=Ge,e.NoiseTexture=Oe,e.NormalPass=Se,e.OutlineEdgesMaterial=q,e.OutlineEffect=He,e.OutlineMaterial=Y,e.OverrideMaterialManager=oe,e.Pass=te,e.PixelationEffect=We,e.PredicationMode={DISABLED:0,DEPTH:1,CUSTOM:2},e.RawImageData=Ye,e.RenderPass=le,e.Resizable=Ae,e.Resizer=$,e.SavePass=be,e.ScanlineEffect=Ze,e.Section=G,e.Selection=Ue,e.SelectiveBloomEffect=Xe,e.ShaderPass=De,Object.defineProperty(e,"__esModule",{value:!0})}));
